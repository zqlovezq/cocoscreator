"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var e="1.0.0";let t=3e3;var i=new class{constructor(){this.config=null,this.queue=[],this.debugMode=!1,this.maxLength=50}track(e={}){if(this.maxLength=!0===e.DEBUG_MODE?3:50,this.config||(this.config=e.config),this.queue.push(e.task),this.queue.length===this.maxLength||!0===e.FLUSH_ALL_TASK){const e=this.queue.slice();this.flush(e),this.queue=[]}}flush(e){var i;e.length>0&&window.wx.request({url:(null===(i=this.config)||void 0===i?void 0:i.serverUrl)||"",timeout:2500,method:"POST",data:Object.assign(Object.assign({},this.config),{data:e}),success:i=>{if(i.data&&0===Number(i.data.code))console.log(`>| 上报成功 >|: ${e.length}条`),t=3e3;else{const{status:e,message:r,error:n}=i.data;console.log(">| 上报失败, 尝试重报 >| status | error | message |: ",`| ${e} | ${n} | ${r} |`),t+=3e3}},fail:e=>{console.error(">| 上报失败, 重新发起上报 >|: ",e),t+=3e3},complete:()=>{t>3e3&&setTimeout((()=>{this.flush(e)}),t)}})}};function r(e){let t;try{t=localStorage.getItem(e)}catch(e){console.log(e)}return t||(t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),localStorage.setItem(e,t)),t}const n=e=>"[object Object]"===Object.prototype.toString.call(e),o=e=>n(e)&&Object.keys(e).length>0;function s(e,t,i,r){if(!n(i)||n(o=i)&&0===Object.keys(o).length)return"YES"===t&&console.log(`${e} 方法的参数必传, 且为对象类型`),!1;var o;const s=Object.keys(i);return r.every((r=>-1!==s.indexOf(r)&&!(e=>("string"==typeof e&&(e=e.trim()),["",null,void 0].includes(e)))(i[r])||("YES"===t&&console.log(`${e} 方法的 ${r} 字段必传, 且不能为空值`),!1)))}function c(e,t,i){return!(!/^[0-9a-zA-Z_-]{1,}$/.test(t)||String(t).length>64)||("YES"===i&&console.log(`${e} 字段的值不合法，只允许包含长度64位以内的字母数字中线下划线`),!1)}function l(e,t=[]){return Object.keys(e).reduce(((i,r)=>{var n;return i[r]=(n=e[r],!["",null,void 0,"null","undefined"].includes(n)&&t.includes(r)?`${e[r]}`:e[r]),i}),{})}function a(e){const t=new Date;let i;const r={"Y+":t.getFullYear().toString(),"M+":(t.getMonth()+1).toString(),"D+":t.getDate().toString(),"H+":t.getHours().toString(),"m+":t.getMinutes().toString(),"s+":t.getSeconds().toString()};return Object.keys(r).forEach((t=>{if(i=new RegExp("("+t+")").exec(e),i){const n=r[t];e=e.replace(i[1],1==i[1].length?n:n.padStart(i[1].length,"0"))}})),e}const d=e,u=["$device_id","$device_model","$os","$os_version","$lib","$lib_version","$app_version","$channel","$scene","$role_id","$role_name","$role_level","$server_id","$ad_ascribe"],g=["$role_id","$role_name","$role_level","$server_id"],h={oldHide:window.wx.onHide,oldShow:window.wx.onShow};function _(e=function(){}){return function(){e&&e.apply(this,arguments)}}let b=0,$=Date.now();function p(){b=0}function m(e,t){!0===e.onHide&&(window.wx.onHide=e=>h.oldHide(function(e=function(){},t){return _((function(){e&&e.apply(this,arguments),"YES"===t.debugEnable&&console.log("小程序关闭了， 上报登出事件");const i={online_duration:parseInt(((Date.now()-$)/1e3).toFixed(0))};t.track("role_logout",i),t.track("logout",Object.assign(Object.assign({},i),{FLUSH_ALL_TASK:!0})),p()}))}(e,t))),!0===e.onShow&&(window.wx.onShow=e=>h.oldShow(function(e=function(){},t){return _((function(){e&&e.apply(this,arguments),"YES"===t.debugEnable&&console.log(">| 进入 onShow 劫持函数 --------------"),$=Date.now(),t.$account_id&&0===b&&("YES"===t.debugEnable&&console.log("这次可以上报登录事件了"),t.track("login"),!t.multipleRoles&&t.track("role_login")),t.$account_id&&0!==b&&$-b>0&&(p(),"YES"===t.debugEnable&&console.log("已经上报过登录事件了，这次 onShow 就不报了")),"YES"===t.debugEnable&&console.log(">| 退出 onShow 劫持函数 --------------")}))}(e,t)))}const f=new class{constructor(){this.$account_id="",this.multipleRoles=!1,this.debugEnable="NO",this.config=null,this.$distinct_id=r("$distinct_id"),this.commonAttrs={},this.getSystemInfo()}init(e){if(console.log(">| GIT INFO OF SDK rainbow.wx.minigame |"),console.log(JSON.stringify({buildDate:"2022-4-2  18:49",commitDate:"2022-4-2  19:22",branchName:"origin/1.2.0",commitHash:"3d48a9a4"})),console.log(">| GIT INFO OF SDK rainbow.wx.minigame |"),!s("init",this.debugEnable,e,["serverUrl","appKey","$app_version","$scene"]))return!1;e.$channel=e.$channel||"1091",e.$ad_ascribe=e.$ad_ascribe||"1091";const{appKey:t,serverUrl:i,debug:n,autoTrack:o,multipleRoles:a}=e,d=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i}(e,["appKey","serverUrl","debug","autoTrack","multipleRoles"]);this.config={appKey:t,serverUrl:i},this.debugEnable=!0===n?"YES":"NO",this.multipleRoles=!0===a,o&&m(o,f),this.unregisterSuperProperties(g),this.$distinct_id=d&&d.$distinct_id&&""!==`${d.$distinct_id}`.trim()?d.$distinct_id:r("$distinct_id");const u=d&&d.$device_id?d.$device_id:r("$device_id"),h=Object.assign(Object.assign({},d),{$device_id:u});if(!c("$distinct_id",this.$distinct_id,this.debugEnable))return!1;const _=l(h,["$channel","$ad_ascribe","$app_version","$scene","$distinct_id","$device_id"]);return this.track("device_start",_),!0}getSystemInfo(){let e=this;window.wx.getSystemInfo({success(t){const{model:i,system:n}=t,o={$device_id:r("$device_id"),$device_model:i,$os_version:n,$os:String(n.split(" ")[0]).toLowerCase(),$lib:"wx-minigame",$lib_version:d};e.registerSuperProperties(o)}})}track(e,t){if(this.config&&this.config.serverUrl&&this.config.appKey){t&&this.registerSuperProperties(t),t&&o(t)&&Object.keys(t).forEach((e=>{this.commonAttrs.hasOwnProperty(e)&&delete t[e]}));const r=Object.assign(Object.assign({},this.config),{data:[{$type:"track",$event_name:e,$account_id:this.$account_id,$distinct_id:this.$distinct_id,$event_time:a("YYYY-MM-DD HH:mm:ss"),properties:Object.assign(Object.assign({},this.commonAttrs),t)}]});i.track({config:this.config,task:r.data[0],FLUSH_ALL_TASK:null==t?void 0:t.FLUSH_ALL_TASK,DEBUG_MODE:"YES"===this.debugEnable})}}registerSuperProperties(e){return!!o(e)&&(Object.keys(e).forEach((t=>{u.includes(t)?this.commonAttrs[t]="$role_level"===t?parseInt(Number(e[t]).toFixed(0)):`${e[t]}`:this.commonAttrs[t]=e[t]})),!0)}unregisterSuperProperties(e){e.forEach((e=>{this.unregisterSuperProperty(e)}))}unregisterSuperProperty(e){return!(!o(this.commonAttrs)||!this.commonAttrs.hasOwnProperty(e))&&(delete this.commonAttrs[e],!0)}getSuperProperties(){return this.commonAttrs}clearSuperProperties(){this.commonAttrs={}}deviceStartWithProperties(e){if(!s("deviceStartWithProperties",this.debugEnable,e,["$app_version","$scene"]))return!1;e.$channel=e.$channel||"1091",e.$ad_ascribe=e.$ad_ascribe||"1091",this.unregisterSuperProperties(g),this.$distinct_id=e.$distinct_id&&""!==`${e.$distinct_id}`.trim()?e.$distinct_id:r("$distinct_id");const t=e.$device_id?e.$device_id:r("$device_id"),i=Object.assign(Object.assign({},e),{$device_id:t});if(!c("$distinct_id",this.$distinct_id,this.debugEnable))return!1;const n=l(i,["$channel","$ad_ascribe","$app_version","$scene","$distinct_id","$device_id"]);return this.track("device_start",n),!0}registerWithProperties(e){return!!s("registerWithProperties",this.debugEnable,e,["$account_id"])&&(this.$account_id=`${e.$account_id}`,!!c("$account_id",this.$account_id,this.debugEnable)&&(this.track("register"),!0))}loginWithProperties(e){return!!s("loginWithProperties",this.debugEnable,e,["$account_id"])&&(b=Date.now(),this.unregisterSuperProperties(g),this.$account_id=e.$account_id,!!c("$account_id",this.$account_id,this.debugEnable)&&(this.track("login",Object.assign(Object.assign({},e),{is_first_login:e.is_first_login||0})),!0))}logoutWithProperties(e){return!!s("logoutWithProperties",this.debugEnable,e,["online_duration"])&&(isNaN(Number(e.online_duration))?("YES"===this.debugEnable&&console.log("logoutWithProperties 方法的 online_duration 字段类型必须是 数值-整数型"),!1):(this.track("logout",Object.assign(Object.assign({},e),{online_duration:parseInt(Number(e.online_duration).toFixed(0)),FLUSH_ALL_TASK:!0})),void p()))}roleCreateWithProperties(e){if(!s("roleCreateWithProperties",this.debugEnable,e,["$role_id","$role_name"]))return!1;if(!c("$role_id",e.$role_id,this.debugEnable))return!1;const t=l(Object.assign(Object.assign({},e),{$server_id:e.$server_id?e.$server_id:"0"}),["$role_id","$role_name","$server_id "]);return this.track("role_create",t),!0}roleLoginWithProperties(e){if(!s("roleLoginWithProperties",this.debugEnable,e,["$role_id","$role_name","$role_level"]))return!1;if(!c("$role_id",e.$role_id,this.debugEnable))return!1;if(isNaN(Number(e.$role_level)))return"YES"===this.debugEnable&&console.log("roleLoginWithProperties 方法参数对象的 $role_level 字段类型必须是 数值-整数型"),!1;const t=Object.assign(Object.assign({},e),{$server_id:e.$server_id?e.$server_id:"0"}),i=Object.assign(Object.assign({},l(t,["$role_id","$role_name","$server_id "])),{$role_level:parseInt(Number(e.$role_level).toFixed(0))});return this.track("role_login",i),!0}roleLogoutWithProperties(e){return!!s("roleLogoutWithProperties",this.debugEnable,e,["online_duration"])&&(isNaN(Number(e.online_duration))?("YES"===this.debugEnable&&console.log("roleLogoutWithProperties 方法的 online_duration 字段类型必须是 数值-整数型"),!1):(this.track("role_logout",Object.assign(Object.assign({},e),{online_duration:parseInt(Number(e.online_duration).toFixed(0))})),void p()))}levelUpWithProperties(e){return!!s("levelUpWithProperties",this.debugEnable,e,["$role_level"])&&(isNaN(Number(e.$role_level))?("YES"===this.debugEnable&&console.log("levelUpWithProperties 方法参数对象的 $role_level 字段类型必须是 数值-整数型"),!1):(this.track("level_up",Object.assign(Object.assign({},e),{$role_level:parseInt(Number(e.$role_level).toFixed(0))})),!0))}orderFinishWithProperties(e){if(!s("orderFinishWithProperties",this.debugEnable,e,["order_id","pay_amount","product_id","product_price","product_name","is_first_pay","pay_method"]))return!1;const t=Object.keys(e).reduce(((e,t)=>(["pay_amount","product_price","is_first_pay"].includes(t)?e[t]=Number(e[t]):e[t]=`${e[t]}`,e)),{});return this.track("order_finish",t),!0}taskFlowWithProperties(e){const t=["task_id","task_type","task_name","task_status"];if(!s("taskFlowWithProperties",this.debugEnable,e,t))return!1;const i=l(e,t);return this.track("task_flow",i),!0}itemFlowWithProperties(e){if(!s("itemFlowWithProperties",this.debugEnable,e,["item_id","item_name","change_type","change_num","change_before","change_after","change_reason","change_subreason"]))return!1;const t=Object.keys(e).reduce(((e,t)=>(["change_num","change_before","change_after"].includes(t)?e[t]=parseInt(Number(e[t]).toFixed(0)):e[t]=`${e[t]}`,e)),{});return this.track("item_flow",t),!0}currencyFlowWithProperties(e){if(!s("currencyFlowWithProperties",this.debugEnable,e,["currency_id","currency_type","change_type","change_num","change_before","change_after","change_reason","change_subreason"]))return!1;const t=Object.keys(e).reduce(((e,t)=>(["change_num","change_before","change_after"].includes(t)?e[t]=parseInt(Number(e[t]).toFixed(0)):e[t]=`${e[t]}`,e)),{});return this.track("currency_flow",t),!0}get sdkVersion(){var e;return null===(e=this.commonAttrs)||void 0===e?void 0:e.$lib_version}enableDebug(e){["YES","NO"].includes(e)&&(this.debugEnable=e)}};module.exports=f;
