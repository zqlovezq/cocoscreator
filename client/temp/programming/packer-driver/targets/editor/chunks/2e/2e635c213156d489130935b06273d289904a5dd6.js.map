{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/fight/drop/DropItem.ts"],"names":["_decorator","Component","Layers","Node","Size","UITransform","Vec2","Vec3","tab","RoguePop","DropControl","Avatar","Func","MathAngle","ViewSize","ccclass","property","halfSize","tempPos","DropItem","dropId","dropTab","avatar","create","nn","layer","Enum","DEFAULT","addComponent","onLoad","uiTrans","node","width","height","setDropItemId","dropItemId","getHalfSize","getData","VirtualItemByVirtualItemId","getValue","addChild","VirtualAnimationId","setAnimationId","checkAddTouch","remove","recycle","destroy","isRogueDrop","on","EventType","TOUCH_START","console","log","setPos","position","x","random","y","checkPos","dropTrans","getComponent","isRandom","angle","angleToDirection","multiplyScalar","pos2","index","checkOverlap","newNode","pos","parent","children","getBoundingBox","contains","frameSize"],"mappings":"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","sourcesContent":["import { _decorator, Component, Layers, Node, Prefab, Size, Sprite, UITransform, Vec2, Vec3, view } from \"cc\";\nimport { tab } from \"../../../Table/table_gen\";\nimport { RoguePop } from \"../view/rogue/RoguePop\";\nimport { DropControl } from \"./DropControl\";\nimport { Avatar } from \"../animation/Avatar\";\nimport { Func } from \"../../utils/Func\";\nimport { MathAngle } from \"../../../framework/collision/Maths\";\nimport { ViewSize } from \"../../define/ViewDefine\";\n\nconst { ccclass, property } = _decorator;\n\nconst halfSize = new Size();\nconst tempPos = new Vec3(0, 0, 0)\n/** 掉落 */\n@ccclass('DropItem')\nexport class DropItem extends Component {\n\n    static create() {\n        let nn = new Node(\"dropNode\")\n        nn.layer = Layers.Enum.DEFAULT\n        return nn.addComponent(DropItem)\n    }\n    protected onLoad(): void {\n        let uiTrans = this.node.addComponent(UITransform)\n        uiTrans.width = uiTrans.height = 80\n    }\n\n    dropId: number\n    dropTab: tab.VirtualItem\n    avatar: Avatar = null;\n    setDropItemId(dropItemId) {\n        this.getHalfSize()\n        this.dropId = dropItemId\n        this.dropTab = tab.getData().VirtualItemByVirtualItemId.getValue(dropItemId)\n\n        let nn = new Node(\"dropNode\")\n        nn.layer = Layers.Enum.DEFAULT\n        this.node.addChild(nn)\n\n        if (this.dropTab.VirtualAnimationId) {\n            this.avatar = Avatar.create()\n            nn.addChild(this.avatar.node)\n            this.avatar.setAnimationId(this.dropTab.VirtualAnimationId)\n        }\n\n\n        // let spr = nn.addComponent(Sprite)\n        // spr.sizeMode = Sprite.SizeMode.RAW\n        // spr.setTexture(this.dropTab.VirtualItemIcon)\n        // spr.node.scale = new Vec3(0.8, 0.8, 0.8)\n\n        this.checkAddTouch()\n    }\n\n    remove() {\n        if (this.avatar) {\n            this.avatar.recycle();\n        }\n        this.avatar = null;\n\n        this.node.destroy()\n\n        //做Avatar回收\n    }\n\n    checkAddTouch() {\n        if (this.isRogueDrop()) {\n            this.node.on(Node.EventType.TOUCH_START, () => {\n                console.log(\"点击了\")\n                RoguePop.create()\n            })\n        }\n    }\n\n    isRogueDrop() {\n        return DropControl.isRogueDrop(this.dropId)\n    }\n\n    setPos(position: Vec3) {\n        if (position == null) {\n            position = new Vec3()\n            position.x = Func.random(0, halfSize.width - 100)\n            position.y = Func.random(-halfSize.height, halfSize.height)\n        } else {\n            if (position.x < 0) {\n                position.x = Func.random(0, halfSize.width - 100)\n            }\n        }\n\n        if (this.isRogueDrop()) {\n            this.checkPos(position)\n        } else {\n            this.node.position = position\n        }\n\n    }\n\n    checkPos(position: Vec3) {\n\n        let dropTrans = this.node.getComponent(UITransform)\n        let isRandom = false\n        if (position.x == 0 && position.y == 0) {\n            let angle = Func.random(0, 360)\n            MathAngle.angleToDirection(angle, position)\n            position.multiplyScalar(Func.random(-300, 300))\n            isRandom = true\n        }\n\n        if (!isRandom) {\n            let pos2 = new Vec2()\n            pos2.x = position.x\n            pos2.y = position.y\n            for (let index = 0; index < 4; index++) {\n                if (this.checkOverlap(this.node, pos2)) {\n                    break\n                }\n                pos2.x = position.x\n                pos2.y = position.y\n                if (index == 0) {\n                    pos2.x += dropTrans.width\n                } else if (index == 1) {\n                    pos2.x -= dropTrans.width\n                } else if (index == 2) {\n                    pos2.y += dropTrans.height\n                } else if (index == 3) {\n                    pos2.y -= dropTrans.height\n                }\n            }\n            position.x = pos2.x\n            position.y = pos2.y\n        }\n\n\n        if (position.x > halfSize.width) {\n            position.x = halfSize.width - dropTrans.width / 2\n        } else if (position.x < -halfSize.width) {\n            position.x = -halfSize.width + dropTrans.width / 2\n        }\n\n        if (position.y > halfSize.height) {\n            position.y = halfSize.height - dropTrans.height / 2\n        } else if (position.y < -halfSize.height) {\n            position.y = -halfSize.height + dropTrans.height / 2\n        }\n\n        this.node.position = position;\n    }\n    checkOverlap(newNode: Node, pos: Vec2): boolean {\n        for (const nn of this.node.parent.children) {\n            if (nn == newNode) {\n                continue;\n            }\n            if (nn.getComponent(UITransform).getBoundingBox().contains(pos)) {\n                return false\n            }\n        }\n        return true;\n    }\n\n    getHalfSize() {\n        if (halfSize.width == 0) {\n            halfSize.width = ViewSize.frameSize.width * 0.5\n            halfSize.height = ViewSize.frameSize.height / 9 * 5 * 0.5\n        }\n\n    }\n\n}"]}