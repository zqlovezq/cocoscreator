{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/association/AssociationGiftPop.ts"],"names":["_decorator","Button","instantiate","Label","Node","Prefab","Sprite","ViewPop","AssociationData","proto","CommonItem","ItemInfo","tab","AssociationGiftItem","AssociationControl","EventMgr","RoleData","ChannelMgr","ShowItemNotEnoughTips","ShowTips","LangMgr","sendChatToGuild","RedMgr","RedDotType","RedComp","RedEventComp","ccclass","property","AssociationGiftPop","_giftData","_giftTab","_bargain_Gift","_guildInfo","_openType","onShow","openData","ins","getAssocitionInfo","getBargainGift","getData","GuildGiftTableById","getValue","tabId","asyncView","com","node","addComponent","redNode","redPoint","evet","event","Guild_Activity","child","types","push","addRed","node_conten","destroyAllChildren","award","itemId","RewardItemId","num","ItemCount","common_item","initData","curPrice","DiamondPrice","lbl_price_total","string","String","i","bargainRecords","length","record","item","pfb_log","parent","itemTs","getComponent","bargainNum","roleId","id","buyGift","isBoughtCycleGift","boughtUpLevelGiftTabIds","indexOf","Id","node_buy","interactable","grayscale","active","getIsMinPrice","node_bargain","lbl_bargain_count","getGuildMembersCount","totalCount","lbl_price_cur","stepNumber","GetKeyValue_ConfigTable","GuildGiftPhase","node_step_1","node_step_2","node_step_3","step","k","_step","register","onMsg","Ptl","BargainGuildRsp","on_s2c_BargainGuildRsp","BuyGuildGiftRsp","on_s2c_BuyGuildGiftRsp","unRegister","onDestroy","onClickBargain","reqBargainGuild","onClickBuy","needDimamond","Number","diamond","reqBuyGuildGift","msg","error","code","CommonErrorCode","Succeed","isHaveGift","gifts","gift","giftId","refreshEvent","console","log","ChatBreviaryType","ChatBreviaryType_GuildGiftLow","onClickShare","ChatBreviaryType_GuildGiftBargain","getLab","share","retData","JSON","stringify"],"mappings":"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","sourcesContent":["/*\r\n * @Date: 2024-09-06 15:09:10\r\n * @LastEditors: wzq\r\n * @LastEditTime: 2024-11-01 11:09:31\r\n * @ 砍价礼包\r\n */\r\n\r\nimport { _decorator, Button, Component, instantiate, Label, Node, Prefab, Sprite } from 'cc';\r\nimport { ViewPop } from '../../../framework/base/ViewPop';\r\nimport { AssociationData } from './AssociationData';\r\nimport { proto } from 'client_protocol';\r\nimport { CommonItem } from '../item/CommonItem';\r\nimport { ItemInfo } from '../item/ItemInfo';\r\nimport { tab } from '../../../Table/table_gen';\r\nimport { AssociationGiftItem } from './AssociationGiftItem';\r\nimport { AssociationControl } from './AssociationControl';\r\nimport { EventMgr } from '../../mgr/EventMgr';\r\nimport { RoleData } from '../role/RoleData';\r\nimport { ChannelMgr } from '../../../channel/ChannelMgr';\r\nimport { ShowItemNotEnoughTips, ShowTips } from '../../mgr/UIMgr';\r\nimport { LangMgr } from '../../mgr/LangMgr';\r\nimport { sendChatToGuild } from '../../utils/GameUtil';\r\nimport { RedMgr } from '../../mgr/RedMgr';\r\nimport { RedDotType } from '../../red/RedDotType';\r\nimport RedComp from '../../../Common/component/RedComp';\r\nimport RedEventComp from '../../../Common/component/RedEventComp';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('AssociationGiftPop')\r\nexport class AssociationGiftPop extends ViewPop {\r\n    @property(Label)\r\n    lbl_price_total: Label = null;\r\n    @property(Label)\r\n    lbl_price_cur: Label = null;\r\n    @property(CommonItem)\r\n    common_item: CommonItem = null;\r\n    @property(Prefab)\r\n    pfb_log: Prefab = null;\r\n    @property(Node)\r\n    node_conten: Node = null;\r\n    @property(Label)\r\n    lbl_bargain_count: Label = null;\r\n    @property(Node)\r\n    node_step_1: Node = null;\r\n    @property(Node)\r\n    node_step_2: Node = null;\r\n    @property(Node)\r\n    node_step_3: Node = null;\r\n    @property(Node)\r\n    node_bargain:Node = null;\r\n    @property(Node)\r\n    node_buy:Node = null;\r\n\r\n    @property(Node)\r\n    redPoint:Node = null;\r\n    private _giftData: proto.GuildGift = null;\r\n    private _giftTab: tab.GuildGiftTable = null;\r\n    private _bargain_Gift: boolean = false;\r\n    private _guildInfo:proto.GuildInfo = null;\r\n    private _openType:string = \"\"\r\n    onShow(): void {\r\n        // 获取公会礼包\r\n        this._openType = this.openData;\r\n        this._guildInfo = AssociationData.ins.getAssocitionInfo();\r\n        this._giftData = AssociationData.ins.getBargainGift(this._openType);\r\n        this._giftTab = tab.getData().GuildGiftTableById.getValue(this._giftData.tabId);\r\n        this.asyncView();\r\n    }\r\n    asyncView() {\r\n        // 加红点逻辑\r\n        let com= this.node.addComponent(RedComp);\r\n        com.redNode=this.redPoint;\r\n        let evet=new RedEventComp();\r\n        evet.event=RedDotType.Guild_Activity;\r\n        evet.child = this.openData\r\n        com.types.push(evet);\r\n        com.addRed();\r\n\r\n        this._bargain_Gift = false;\r\n        this.node_conten.destroyAllChildren();\r\n        const award = new ItemInfo();\r\n        award.itemId = this._giftTab.RewardItemId\r\n        award.num = this._giftTab.ItemCount\r\n        this.common_item.initData(award);\r\n        let curPrice = this._giftTab.DiamondPrice;\r\n        this.lbl_price_total.string = String(this._giftTab.DiamondPrice);\r\n        for (let i = 0; i < this._giftData.bargainRecords.length; i++) {\r\n            const record: proto.IBargainRecord = this._giftData.bargainRecords[i];\r\n            const item = instantiate(this.pfb_log);\r\n            item.parent = this.node_conten;\r\n            const itemTs = item.getComponent(AssociationGiftItem);\r\n            itemTs.initData(record);\r\n            curPrice -= record.bargainNum;\r\n            if (record.roleId === RoleData.ins.id) {\r\n                this._bargain_Gift = true;\r\n            }\r\n        }\r\n\r\n        let buyGift = false;\r\n        if(this._giftTab.Button===\"gift_btn1\"){\r\n            buyGift = this._guildInfo.isBoughtCycleGift;\r\n        }else if(this._giftTab.Button===\"gift_btn2\"){\r\n            buyGift = this._guildInfo.boughtUpLevelGiftTabIds.indexOf(this._giftTab.Id)>-1;\r\n        }\r\n        if(buyGift){\r\n            this.node_buy.getComponent(Button).interactable = false;\r\n            this.node_buy.getComponent(Sprite).grayscale = true;\r\n        }\r\n        this.node_buy.active = this._bargain_Gift||buyGift||AssociationData.ins.getIsMinPrice(this._openType)\r\n        this.node_bargain.active = !this.node_buy.active;\r\n        // 获取当前公会最大人数\r\n        this.lbl_bargain_count.string = this._giftData.bargainRecords.length + \"/\" + AssociationData.ins.getGuildMembersCount().totalCount;\r\n        // 当前的价格\r\n        this.lbl_price_cur.string = String(curPrice);\r\n        // 当前的阶段\r\n        const stepNumber = tab.getData().GetKeyValue_ConfigTable().GuildGiftPhase;\r\n        this.node_step_1.active = false;\r\n        this.node_step_2.active = false;\r\n        this.node_step_3.active = false;\r\n        let step = 3;\r\n        for (let k = 0; k < stepNumber.length; k++) {\r\n            const _step = stepNumber[k] / 10000;\r\n            if (curPrice / this._giftTab.DiamondPrice > _step) {\r\n                step = k + 1;\r\n                break;\r\n            }\r\n        }\r\n        this[\"node_step_\"+step].active = true;\r\n    }\r\n    register(): void {\r\n        /* 监听公会砍价 */\r\n        EventMgr.onMsg(proto.Ptl.BargainGuildRsp, this.on_s2c_BargainGuildRsp, this);\r\n        /* 监听购买公会礼包 */\r\n        EventMgr.onMsg(proto.Ptl.BuyGuildGiftRsp, this.on_s2c_BuyGuildGiftRsp, this);\r\n    }\r\n    unRegister(): void {\r\n        super.unRegister();\r\n    }\r\n    protected onDestroy(): void {\r\n        super.onDestroy()\r\n    }\r\n    onClickBargain() {\r\n        AssociationControl.ins.reqBargainGuild(this._giftData.id);\r\n    }\r\n    onClickBuy() {\r\n        const needDimamond = Number(this.lbl_price_cur.string);\r\n        if(RoleData.ins.diamond<needDimamond){\r\n            ShowItemNotEnoughTips(1);\r\n            return;\r\n        }\r\n        AssociationControl.ins.reqBuyGuildGift(this._giftData.id);\r\n    }\r\n    /* 砍价 */\r\n    on_s2c_BargainGuildRsp(msg: proto.Msg_BargainGuildRsp) {\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        let isHaveGift = false\r\n        for(let i=0;i<this._guildInfo.gifts.length;i++){\r\n            let gift = this._guildInfo.gifts[i];\r\n            if(gift.id===msg.giftId){\r\n                this._guildInfo.gifts[i] = msg.gift;\r\n                isHaveGift = true;\r\n                break;\r\n            }\r\n        }\r\n        if(!isHaveGift){\r\n            this._guildInfo.gifts.push(msg.gift);\r\n        }\r\n\r\n        this._giftData = msg.gift as proto.GuildGift;\r\n        RedMgr.refreshEvent(RedDotType.Guild_Activity);\r\n        this.asyncView();\r\n        // 判断当前是否是最低价 如果是发送公会聊天\r\n        if(AssociationData.ins.getIsMinPrice(this._openType)){\r\n            console.log(\"cocos 最底价像聊天发送信息\")\r\n            sendChatToGuild(tab.ChatBreviaryType.ChatBreviaryType_GuildGiftLow);\r\n        }\r\n    }\r\n    /* 购买礼包 */\r\n    on_s2c_BuyGuildGiftRsp(msg: proto.Msg_BuyGuildGiftRsp) {\r\n        /* 钻石是否足够 */\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        if(this._openType===\"gift_btn1\"){\r\n            this._guildInfo.isBoughtCycleGift = true;\r\n        }else if(this._openType===\"gift_btn2\"){\r\n            this._guildInfo.boughtUpLevelGiftTabIds.push(this._giftTab.Id);\r\n        }\r\n        this.node_buy.getComponent(Button).interactable = false;\r\n        this.node_buy.getComponent(Sprite).grayscale = true;\r\n    }\r\n    onClickShare(){\r\n        console.log(\"js调用分享\")\r\n        sendChatToGuild(tab.ChatBreviaryType.ChatBreviaryType_GuildGiftBargain);\r\n        ShowTips(LangMgr.getLab(\"ui_association_62\"));\r\n        ChannelMgr.share({'url':\"\"}, (retData) => {\r\n           console.log(\"################ share \" + JSON.stringify(retData));\r\n            if (retData.code == 0) {\r\n                // this.testLoopTask();\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\n\r\n"]}