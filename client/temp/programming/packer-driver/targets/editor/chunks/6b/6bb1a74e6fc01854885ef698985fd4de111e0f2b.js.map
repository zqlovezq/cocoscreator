{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/startScrpit/UpdateView.ts"],"names":["_decorator","Component","game","Label","native","ProgressBar","Global","Func","ChannelMgr","ccclass","property","UpdateView","_updating","_canRetry","_storagePath","_am","_checkListener","_updateListener","_failCount","versionCompareHandle","cb","onLoad","verLab","string","lab","showBar","setCb","_cb","check","loadUpdate","paths","fileUtils","getSearchPaths","length","getWritablePath","console","log","versionA","versionB","vA","split","vB","i","a","parseInt","b","AssetsManager","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","RES_VERSION","getLocalManifest","getVersion","getVersionStr","checkUpdate","setCDNUrl","getHotUpdateURL","setEventCallback","checkCb","bind","event","getEventCode","isGame","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","gameHotfixStart","setProgress","hotUpdate","isShow","bar","node","active","progress","progressStr","toFixed","updateCb","update","needRestart","failed","UPDATE_PROGRESSION","checkInt","getPercent","UPDATE_FINISHED","gameHotfixSuccess","UPDATE_FAILED","retry","ERROR_UPDATING","getAssetId","getMessage","ERROR_DECOMPRESS","restart","downloadFailedAssets"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAA2DC,MAAAA,S,OAAAA,S;AAAqBC,MAAAA,I,OAAAA,I;AAAmBC,MAAAA,K,OAAAA,K;AAAeC,MAAAA,M,OAAAA,M;AAA4BC,MAAAA,W,OAAAA,W;;AAC9IC,MAAAA,M,iBAAAA,M;;AACAC,MAAAA,I,iBAAAA,I;;AACAC,MAAAA,U,iBAAAA,U;;;;;;;;;OAEH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBV,U;;4BAIjBW,U,WADZF,OAAO,CAAC,YAAD,C,UAGHC,QAAQ,CAACL,WAAD,C,UAGRK,QAAQ,CAACP,KAAD,C,UAGRO,QAAQ,CAACP,KAAD,C,2BATb,MACaQ,UADb,SACgCV,SADhC,CAC0C;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAW9BW,SAX8B,GAWlB,KAXkB;AAAA,eAY9BC,SAZ8B,GAYlB,KAZkB;AAAA,eAa9BC,YAb8B,GAaf,EAbe;AAAA,eAc9BC,GAd8B,GAcF,IAdE;AAAA,eAe9BC,cAf8B,GAeb,IAfa;AAAA,eAgB9BC,eAhB8B,GAgBZ,IAhBY;AAAA,eAiB9BC,UAjB8B,GAiBjB,CAjBiB;AAAA,eAkB9BC,oBAlB8B,GAkByC,IAlBzC;AAAA,eAoBtCC,EApBsC;AAAA;;AAqB5BC,QAAAA,MAAM,GAAS;AACrB,eAAKC,MAAL,CAAYC,MAAZ,GAAqB,EAArB;AACA,eAAKC,GAAL,CAASD,MAAT,GAAkB,EAAlB;AACA,eAAKE,OAAL,CAAa,KAAb;AACH;;AAEDC,QAAAA,KAAK,CAACC,GAAD,EAAgB;AACjB,eAAKP,EAAL,GAAUO,GAAV;AACH;;AAEDC,QAAAA,KAAK,GAAG;AACJ,eAAKC,UAAL;AACH;;AAGDA,QAAAA,UAAU,GAAG;AACT,cAAIC,KAAK,GAAG1B,MAAM,CAAC2B,SAAP,CAAiBC,cAAjB,EAAZ;;AACA,cAAIF,KAAK,IAAIA,KAAK,CAACG,MAAN,GAAe,CAA5B,EAA8B;AAC1B,iBAAKnB,YAAL,GAAoBV,MAAM,CAAC2B,SAAP,CAAiBC,cAAjB,GAAkC,CAAlC,CAApB;AACH,WAFD,MAEK;AACD,iBAAKlB,YAAL,GAAqB,CAACV,MAAM,CAAC2B,SAAP,GAAmB3B,MAAM,CAAC2B,SAAP,CAAiBG,eAAjB,EAAnB,GAAwD,GAAzD,IAAgE,WAArF;AACH;;AACDC,UAAAA,OAAO,CAACC,GAAR,CAAY,qCAAqC,KAAKtB,YAAtD;AACAqB,UAAAA,OAAO,CAACC,GAAR,CAAY,QAAZ,EAAqBN,KAArB,EARS,CAUT;AACA;AACA;AACA;;AACA,eAAKX,oBAAL,GAA4B,UAAUkB,QAAV,EAA4BC,QAA5B,EAA8C;AACtEH,YAAAA,OAAO,CAACC,GAAR,CAAY,6CAA6CC,QAA7C,GAAwD,iBAAxD,GAA4EC,QAAxF;AACA,gBAAIC,EAAE,GAAGF,QAAQ,CAACG,KAAT,CAAe,GAAf,CAAT;AACA,gBAAIC,EAAE,GAAGH,QAAQ,CAACE,KAAT,CAAe,GAAf,CAAT;;AACA,iBAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,EAAE,CAACN,MAAvB,EAA+B,EAAES,CAAjC,EAAoC;AAChC,kBAAIC,CAAC,GAAGC,QAAQ,CAACL,EAAE,CAACG,CAAD,CAAH,CAAhB;AACA,kBAAIG,CAAC,GAAGD,QAAQ,CAACH,EAAE,CAACC,CAAD,CAAF,IAAS,GAAV,CAAhB;;AACA,kBAAIC,CAAC,KAAKE,CAAV,EAAa;AACT;AACH,eAFD,MAGK;AACD,uBAAOF,CAAC,GAAGE,CAAX;AACH;AACJ;;AACD,gBAAIJ,EAAE,CAACR,MAAH,GAAYM,EAAE,CAACN,MAAnB,EAA2B;AACvB,qBAAO,CAAC,CAAR;AACH,aAFD,MAGK;AACD,qBAAO,CAAP;AACH;AACJ,WApBD,CAdS,CAoCT;;;AACA,eAAKlB,GAAL,GAAW,IAAIX,MAAM,CAAC0C,aAAX,CAAyB,0BAAzB,EAAqD,KAAKhC,YAA1D,EAAwE,KAAKK,oBAA7E,CAAX,CArCS,CAuCT;AACA;;AACA,eAAKJ,GAAL,CAASgC,iBAAT,CAA2B,UAAUC,IAAV,EAAwBC,KAAxB,EAAoC;AAC3D;AACA,gBAAIC,UAAU,GAAGD,KAAK,CAACC,UAAvB,CAF2D,CAG3D;;AACA,gBAAIC,WAAW,GAAGF,KAAK,CAACG,GAAxB,CAJ2D,CAK3D;;AACA,gBAAIC,YAAY,GAAGJ,KAAK,CAACD,IAAzB,CAN2D,CAO3D;;AACA,gBAAIM,IAAI,GAAGL,KAAK,CAACK,IAAjB;;AACA,gBAAIJ,UAAJ,EAAgB;AACZ,qBAAO,IAAP;AACH,aAFD,MAGK;AACD,qBAAO,IAAP;AACH;AACJ,WAfD;;AAgBA;AAAA;AAAA,gCAAOK,WAAP,GAAqB,KAAKxC,GAAL,CAASyC,gBAAT,GAA4BC,UAA5B,EAArB;AACA,eAAKnC,MAAL,CAAYC,MAAZ,GAAqB;AAAA;AAAA,gCAAOmC,aAAP,EAArB;AACH;;AAEDC,QAAAA,WAAW,GAAG;AACV,cAAI,KAAK/C,SAAT,EAAoB;AAChB;AACH;;AAED,eAAKG,GAAL,CAAS6C,SAAT,CAAmB;AAAA;AAAA,gCAAOC,eAAP,EAAnB;;AACA,eAAK9C,GAAL,CAAS+C,gBAAT,CAA0B,KAAKC,OAAL,CAAaC,IAAb,CAAkB,IAAlB,CAA1B;;AAEA,eAAKjD,GAAL,CAAS4C,WAAT;;AACA,eAAK/C,SAAL,GAAiB,IAAjB;AACH;;AAEDmD,QAAAA,OAAO,CAACE,KAAD,EAAa;AAChB9B,UAAAA,OAAO,CAACC,GAAR,CAAY,WAAW6B,KAAK,CAACC,YAAN,EAAvB;AACA,cAAIC,MAAM,GAAG,KAAb;;AACA,kBAAQF,KAAK,CAACC,YAAN,EAAR;AACI,iBAAK9D,MAAM,CAACgE,kBAAP,CAA0BC,uBAA/B;AACI;AACAF,cAAAA,MAAM,GAAG,IAAT;AACAhC,cAAAA,OAAO,CAACC,GAAR,CAAY,mBAAZ;AACA;;AACJ,iBAAKhC,MAAM,CAACgE,kBAAP,CAA0BE,uBAA/B;AACA,iBAAKlE,MAAM,CAACgE,kBAAP,CAA0BG,oBAA/B;AACIJ,cAAAA,MAAM,GAAG,IAAT;AACAhC,cAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;AACA;;AACJ,iBAAKhC,MAAM,CAACgE,kBAAP,CAA0BI,kBAA/B;AACI;AACAL,cAAAA,MAAM,GAAG,IAAT;AACAhC,cAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ;AACA;;AACJ,iBAAKhC,MAAM,CAACgE,kBAAP,CAA0BK,iBAA/B;AACI;AACAtC,cAAAA,OAAO,CAACC,GAAR,CAAY,UAAZ;AACA;AAAA;AAAA,4CAAWsC,eAAX;AACA,mBAAKjD,OAAL,CAAa,IAAb;AACA,mBAAKkD,WAAL,CAAiB,IAAjB;AACAR,cAAAA,MAAM,GAAG,KAAT;AACA;;AACJ;AACI;AAzBR;;AA4BA,eAAKpD,GAAL,CAAS+C,gBAAT,CAA0B,IAA1B;;AACA,eAAK9C,cAAL,GAAsB,IAAtB;AACA,eAAKJ,SAAL,GAAiB,KAAjB;;AACA,cAAIuD,MAAJ,EAAY;AACR,iBAAK/C,EAAL;AACH,WAFD,MAEO;AACH,iBAAKwD,SAAL;AACH;AACJ;;AAEDnD,QAAAA,OAAO,CAACoD,MAAD,EAAkB;AACrB,eAAKC,GAAL,CAASC,IAAT,CAAcC,MAAd,GAAuB,KAAKxD,GAAL,CAASuD,IAAT,CAAcC,MAAd,GAAuBH,MAA9C;AACH;;AACDF,QAAAA,WAAW,CAACM,QAAD,EAAmB;AAC1B,cAAIC,WAAW,GAAG,CAACD,QAAQ,GAAG,GAAZ,EAAiBE,OAAjB,CAAyB,CAAzB,IAA8B,GAAhD;AACA,eAAKL,GAAL,CAASG,QAAT,GAAoBA,QAApB;AACA,eAAKzD,GAAL,CAASD,MAAT,GAAkB2D,WAAlB;AACH;;AAEDN,QAAAA,SAAS,GAAG;AACR,cAAI,KAAK7D,GAAL,IAAY,CAAC,KAAKH,SAAtB,EAAiC;AAC7B,iBAAKG,GAAL,CAAS+C,gBAAT,CAA0B,KAAKsB,QAAL,CAAcpB,IAAd,CAAmB,IAAnB,CAA1B;;AAEA,iBAAK9C,UAAL,GAAkB,CAAlB;;AACA,iBAAKH,GAAL,CAASsE,MAAT;;AACA,iBAAKzE,SAAL,GAAiB,IAAjB;AACH;AACJ;;AAEDwE,QAAAA,QAAQ,CAACnB,KAAD,EAAa;AACjB,cAAIqB,WAAW,GAAG,KAAlB;AACA,cAAIC,MAAM,GAAG,KAAb;;AACA,kBAAQtB,KAAK,CAACC,YAAN,EAAR;AACI,iBAAK9D,MAAM,CAACgE,kBAAP,CAA0BC,uBAA/B;AACIlC,cAAAA,OAAO,CAACC,GAAR,CAAY,mBAAZ;AACAmD,cAAAA,MAAM,GAAG,IAAT;AACA;;AACJ,iBAAKnF,MAAM,CAACgE,kBAAP,CAA0BoB,kBAA/B;AACI;AACA,mBAAKb,WAAL,CAAiB;AAAA;AAAA,gCAAKc,QAAL,CAAcxB,KAAK,CAACyB,UAAN,EAAd,CAAjB;AACA;;AACJ,iBAAKtF,MAAM,CAACgE,kBAAP,CAA0BE,uBAA/B;AACA,iBAAKlE,MAAM,CAACgE,kBAAP,CAA0BG,oBAA/B;AACIpC,cAAAA,OAAO,CAACC,GAAR,CAAY,iBAAZ;AACAmD,cAAAA,MAAM,GAAG,IAAT;AACA;;AACJ,iBAAKnF,MAAM,CAACgE,kBAAP,CAA0BI,kBAA/B;AACIrC,cAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ;AACAmD,cAAAA,MAAM,GAAG,IAAT;AACA;;AACJ,iBAAKnF,MAAM,CAACgE,kBAAP,CAA0BuB,eAA/B;AACI;AACAxD,cAAAA,OAAO,CAACC,GAAR,CAAY,MAAZ;AACAkD,cAAAA,WAAW,GAAG,IAAd;AACA;AAAA;AAAA,4CAAWM,iBAAX;AACA;;AACJ,iBAAKxF,MAAM,CAACgE,kBAAP,CAA0ByB,aAA/B;AACI;AACA1D,cAAAA,OAAO,CAACC,GAAR,CAAY,eAAZ;AACA,mBAAKxB,SAAL,GAAiB,KAAjB;AACA,mBAAKC,SAAL,GAAiB,IAAjB;AACA,mBAAKiF,KAAL;AACA;;AACJ,iBAAK1F,MAAM,CAACgE,kBAAP,CAA0B2B,cAA/B;AACI;AACA5D,cAAAA,OAAO,CAACC,GAAR,CAAY,aAAa6B,KAAK,CAAC+B,UAAN,EAAb,GAAkC,IAAlC,GAAyC/B,KAAK,CAACgC,UAAN,EAArD;AACA;;AACJ,iBAAK7F,MAAM,CAACgE,kBAAP,CAA0B8B,gBAA/B;AACI;AACA/D,cAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ;AACA;;AACJ;AACI;AAxCR;;AA2CA,cAAImD,MAAJ,EAAY;AACR,iBAAKxE,GAAL,CAAS+C,gBAAT,CAA0B,IAA1B;;AACA,iBAAK7C,eAAL,GAAuB,IAAvB;AACA,iBAAKL,SAAL,GAAiB,KAAjB;AACH;;AAED,cAAI0E,WAAJ,EAAiB;AACb,iBAAKvE,GAAL,CAAS+C,gBAAT,CAA0B,IAA1B;;AACA,iBAAK7C,eAAL,GAAuB,IAAvB;AACAf,YAAAA,IAAI,CAACiG,OAAL,GAHa,CAIb;AACH;AACJ;;AAEDL,QAAAA,KAAK,GAAG;AACJ,cAAI,CAAC,KAAKlF,SAAN,IAAmB,KAAKC,SAA5B,EAAuC;AACnC,iBAAKA,SAAL,GAAiB,KAAjB;AAEA,iBAAKW,GAAL,CAASD,MAAT,GAAkB,SAAlB;;AACA,iBAAKR,GAAL,CAASqF,oBAAT;AACH;AACJ;;AA5OqC,O;;;;;iBAGnB,I;;;;;;;iBAGN,I;;;;;;;iBAGG,I","sourcesContent":["import { _decorator, assetManager, BlockInputEvents, Button, Color, Component, director, game, instantiate, Label, Layers, native, Node, path, Prefab, ProgressBar, ResolutionPolicy, Sprite, tween, UITransform, Vec3, view } from 'cc';\nimport { Global } from '../Global';\nimport { Func } from '../logic/utils/Func';\nimport { ChannelMgr } from '../channel/ChannelMgr';\n\nconst { ccclass, property } = _decorator;\n\n\n@ccclass('UpdateView')\nexport class UpdateView extends Component {\n\n    @property(ProgressBar)\n    bar: ProgressBar = null\n\n    @property(Label)\n    lab: Label = null\n\n    @property(Label)\n    verLab: Label = null\n\n    private _updating = false;\n    private _canRetry = false;\n    private _storagePath = '';\n    private _am: native.AssetsManager = null!;\n    private _checkListener = null;\n    private _updateListener = null;\n    private _failCount = 0;\n    private versionCompareHandle: (versionA: string, versionB: string) => number = null!;\n\n    cb: Function\n    protected onLoad(): void {\n        this.verLab.string = \"\"\n        this.lab.string = \"\"\n        this.showBar(false)\n    }\n\n    setCb(_cb: Function) {\n        this.cb = _cb\n    }\n\n    check() {\n        this.loadUpdate()\n    }\n\n\n    loadUpdate() {\n        let paths = native.fileUtils.getSearchPaths()\n        if (paths && paths.length > 0){\n            this._storagePath = native.fileUtils.getSearchPaths()[0]\n        }else{\n            this._storagePath = ((native.fileUtils ? native.fileUtils.getWritablePath() : '/') + 'newUpdate');\n        }\n        console.log('Storage path for remote asset : ' + this._storagePath);\n        console.log(\"当前搜索路径\",paths)\n        \n        // // Setup your own version compare handler, versionA and B is versions in string\n        // // if the return value greater than 0, versionA is greater than B,\n        // // if the return value equals 0, versionA equals to B,\n        // // if the return value smaller than 0, versionA is smaller than B.\n        this.versionCompareHandle = function (versionA: string, versionB: string) {\n            console.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\n            var vA = versionA.split('.');\n            var vB = versionB.split('.');\n            for (var i = 0; i < vA.length; ++i) {\n                var a = parseInt(vA[i]);\n                var b = parseInt(vB[i] || '0');\n                if (a === b) {\n                    continue;\n                }\n                else {\n                    return a - b;\n                }\n            }\n            if (vB.length > vA.length) {\n                return -1;\n            }\n            else {\n                return 0;\n            }\n        };\n\n        // // Init with empty manifest url for testing custom manifest\n        this._am = new native.AssetsManager('version/project.manifest', this._storagePath, this.versionCompareHandle);\n\n        // // Setup the verification callback, but we don't have md5 check function yet, so only print some message\n        // // Return true if the verification passed, otherwise return false\n        this._am.setVerifyCallback(function (path: string, asset: any) {\n            // // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\n            var compressed = asset.compressed;\n            // // Retrieve the correct md5 value.\n            var expectedMD5 = asset.md5;\n            // // asset.path is relative path and path is absolute.\n            var relativePath = asset.path;\n            // // The size of asset file, but this value could be absent.\n            var size = asset.size;\n            if (compressed) {\n                return true;\n            }\n            else {\n                return true;\n            }\n        });\n        Global.RES_VERSION = this._am.getLocalManifest().getVersion()\n        this.verLab.string = Global.getVersionStr()\n    }\n\n    checkUpdate() {\n        if (this._updating) {\n            return;\n        }\n\n        this._am.setCDNUrl(Global.getHotUpdateURL())\n        this._am.setEventCallback(this.checkCb.bind(this));\n\n        this._am.checkUpdate();\n        this._updating = true;\n    }\n\n    checkCb(event: any) {\n        console.log('Code: ' + event.getEventCode());\n        var isGame = false\n        switch (event.getEventCode()) {\n            case native.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                // //下载清单文件失败，跳过热更新。\n                isGame = true\n                console.log(\"找不到本地清单文件，跳过了热更新。\")\n                break;\n            case native.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case native.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                isGame = true\n                console.log(\"下载清单文件失败，跳过热更新。\")\n                break;\n            case native.EventAssetsManager.ALREADY_UP_TO_DATE:\n                // //已经更新了最新的远程版本。\n                isGame = true\n                console.log(\"已经更新了最新的远程版本。\")\n                break;\n            case native.EventAssetsManager.NEW_VERSION_FOUND:\n                // //可以开始更新游戏\n                console.log(\"可以开始更新游戏\")\n                ChannelMgr.gameHotfixStart()\n                this.showBar(true)\n                this.setProgress(0.01)\n                isGame = false\n                break;\n            default:\n                return;\n        }\n\n        this._am.setEventCallback(null!);\n        this._checkListener = null;\n        this._updating = false;\n        if (isGame) {\n            this.cb()\n        } else {\n            this.hotUpdate()\n        }\n    }\n\n    showBar(isShow: boolean) {\n        this.bar.node.active = this.lab.node.active = isShow\n    }\n    setProgress(progress: number) {\n        let progressStr = (progress * 100).toFixed(2) + '%'\n        this.bar.progress = progress\n        this.lab.string = progressStr\n    }\n\n    hotUpdate() {\n        if (this._am && !this._updating) {\n            this._am.setEventCallback(this.updateCb.bind(this));\n\n            this._failCount = 0;\n            this._am.update();\n            this._updating = true;\n        }\n    }\n\n    updateCb(event: any) {\n        var needRestart = false;\n        var failed = false;\n        switch (event.getEventCode()) {\n            case native.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                console.log('找不到本地清单文件，跳过了热更新。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.UPDATE_PROGRESSION:\n                // //更新中\n                this.setProgress(Func.checkInt(event.getPercent()))\n                break;\n            case native.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case native.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                console.log('下载清单文件失败，跳过热更新。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.ALREADY_UP_TO_DATE:\n                console.log('已经更新了最新的远程版本。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.UPDATE_FINISHED:\n                // //更新完成\n                console.log('更新完成')\n                needRestart = true;\n                ChannelMgr.gameHotfixSuccess()\n                break;\n            case native.EventAssetsManager.UPDATE_FAILED:\n                // //更新失败 可以尝试再次更新\n                console.log('更新失败 可以尝试再次更新')\n                this._updating = false;\n                this._canRetry = true;\n                this.retry()\n                break;\n            case native.EventAssetsManager.ERROR_UPDATING:\n                // //资源更新错误\n                console.log('资源更新错误: ' + event.getAssetId() + ', ' + event.getMessage())\n                break;\n            case native.EventAssetsManager.ERROR_DECOMPRESS:\n                // //解压时出错\n                console.log('解压时出错')\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            this._updating = false;\n        }\n\n        if (needRestart) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            game.restart()\n            //热更完成\n        }\n    }\n\n    retry() {\n        if (!this._updating && this._canRetry) {\n            this._canRetry = false;\n\n            this.lab.string = \"重试失败的文件\"\n            this._am.downloadFailedAssets();\n        }\n    }\n}\n\n"]}