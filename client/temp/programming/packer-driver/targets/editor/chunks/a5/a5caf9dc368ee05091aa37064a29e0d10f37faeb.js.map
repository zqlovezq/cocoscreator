{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/item/ItemControl.ts"],"names":["ItemControl","_decorator","AbsControl","proto","tab","EventMgr","ItemData","HeroData","EquipData","RareBookData","HeroRed","RedMgr","RedDotType","RoleData","ccclass","property","ins","_instance","register","onMsg","Ptl","ItemChangePush","on_s2c_Msg_ItemChangePush","registerCalculateFb","Bag_Compose","on_Red_BagCompose","HeroBagRed","red_hero_Bag","requestItems","msg","adds","updatedItems","updatedHeroes","updatedEquipments","addBooks","updatedBooks","refreshHeroRedData","index","removedItems","length","v","itemType","getData","ItemTableById","getValue","itemId","Type","ItemType","ItemType_Hero","remove","id","ItemType_Equip","updatedSingleItems","i","itemTab","ItemType_Head","avatarInfo","headIcons","push","clientData","indexOf","setClientData","ItemType_HeadFrame","headFrames","ItemType_ChatBubble","chatBubbles","ItemType_MainScene","mainScenes","refreshEvent","Head_Icon_Red","addTestData","tests","item","Item","num","item2","item3","item4","item5","item6","item7","itemList","getItems","value","bagType","itemTable","BagType","BagType_Fragment","needNum","DropId","Number","stateToChange","BagType_Goods","ItemType_Box"],"mappings":"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","sourcesContent":["import { Node, _decorator, js, sys } from \"cc\";\nimport { AbsControl } from \"../../../framework/base/IAbs\";\nimport { proto } from \"client_protocol\";\nimport { Net } from \"../../net/Net\";\nimport { tab } from \"../../../Table/table_gen\";\nimport { EventMgr } from \"../../mgr/EventMgr\";\nimport { ItemData } from \"./ItemData\";\nimport { HeroData } from \"../hero/HeroData\";\nimport { EquipData } from \"../equip/EquipData\";\nimport { RareBookData } from \"../rareBook/RareBookData\";\nimport { HeroRed } from \"../hero/herobag/HeroRed\";\nimport { RedMgr } from \"../../mgr/RedMgr\";\nimport { RedDotType } from \"../../red/RedDotType\";\nimport { OpenFunctionMgr } from \"../../../Common/component/OpenFunctionMgr\";\nimport { RoleData } from \"../role/RoleData\";\n\nconst { ccclass, property } = _decorator;\n\n/** 道具 */\nexport class ItemControl extends AbsControl {\n\n    private static _instance: ItemControl;\n    public static get ins() {\n        if (null == this._instance) {\n            this._instance = new ItemControl();\n        }\n        return this._instance;\n    }\n\n    register(): void {\n        // EventMgr.onMsg(proto.Ptl.GetItemsByTypeRsp, this.on_s2c_GetItemsByTypeRsp, this)\n        EventMgr.onMsg(proto.Ptl.ItemChangePush, this.on_s2c_Msg_ItemChangePush, this)\n        // this.addTestData();\n        RedMgr.ins.registerCalculateFb(RedDotType.Bag_Compose, this.on_Red_BagCompose, this);\n        RedMgr.ins.registerCalculateFb(RedDotType.HeroBagRed, this.red_hero_Bag, this);\n    }\n\n    requestItems() {\n        // let msg = new proto.Msg_GetItemsByTypeReq()\n        // msg.types = [\n        //     tab.ItemType.ItemType_Currency,\n        //     tab.ItemType.ItemType_IdleReward,\n        //     tab.ItemType.ItemType_Piece,\n        //     tab.ItemType.ItemType_Material,\n        //     tab.ItemType.ItemType_Gift\n        // ]\n        // Net.Send(proto.Ptl.GetItemsByTypeReq, msg)\n    }\n\n\n\n    // on_s2c_GetItemsByTypeRsp(msg: proto.Msg_GetItemsByTypeRsp) {\n    //     ItemData.ins.purge()\n    //     ItemData.ins.adds(msg.items as proto.Item[])\n    //     /* 增加一些简单道具 */\n    //     let items = RoleData.ins.simpleItems;\n    //     ItemData.ins.adds(items as proto.Item[]);\n    // }\n\n    on_s2c_Msg_ItemChangePush(msg: proto.Msg_ItemChangePush) {\n        //道具变更\n        ItemData.ins.adds(msg.updatedItems as proto.Item[])\n        //英雄变更\n        HeroData.ins.adds(msg.updatedHeroes as proto.Hero[])\n        //装备变更\n        EquipData.ins.adds(msg.updatedEquipments as proto.EquipData[])\n        RareBookData.ins.addBooks(msg.updatedBooks as proto.BookData[])\n        // 材料变化刷新红点数据\n        HeroRed.ins.refreshHeroRedData();\n        //英雄、装备 删除  （道具数量为0不删除）\n        for (let index = 0; index < msg.removedItems.length; index++) {\n            const v = msg.removedItems[index];\n            let itemType = tab.getData().ItemTableById.getValue(v.itemId).Type;\n            switch (itemType) {\n                case tab.ItemType.ItemType_Hero:\n                    //英雄删除\n                    HeroData.ins.remove(v.id)\n                    break\n                case tab.ItemType.ItemType_Equip:\n                    //装备删除\n                    EquipData.ins.remove(v.id)\n                    break\n\n            }\n        }\n        /* 道具更新头像等道具 */\n        if(msg.updatedSingleItems.length>0){\n            for(let i=0;i<msg.updatedSingleItems.length;i++){\n                const itemId = msg.updatedSingleItems[i].itemId;\n                const itemTab = tab.getData().ItemTableById.getValue(itemId);\n                if(itemTab.Type===tab.ItemType.ItemType_Head){\n                    RoleData.ins.avatarInfo.headIcons.push(msg.updatedSingleItems[i]);\n                    const clientData = RoleData.ins.clientData[\"newHeadIcon\"];\n                    if(clientData){\n                        if(clientData.indexOf(\"\"+itemId)===-1){\n                            RoleData.ins.setClientData(\"newHeadIcon\",clientData+\",\"+itemId)\n                        }\n                    }else{\n                        RoleData.ins.setClientData(\"newHeadIcon\",\",\"+itemId)\n                    }\n                }else if(itemTab.Type===tab.ItemType.ItemType_HeadFrame){\n                    RoleData.ins.avatarInfo.headFrames.push(msg.updatedSingleItems[i]);\n                    const clientData = RoleData.ins.clientData[\"newHeadFrame\"];\n                    if(clientData){\n                        if(clientData.indexOf(\"\"+itemId)===-1){\n                            RoleData.ins.setClientData(\"newHeadFrame\",clientData+\",\"+itemId)\n                        }\n                    }else{\n                        RoleData.ins.setClientData(\"newHeadFrame\",\",\"+itemId)\n                    }\n                }else if(itemTab.Type===tab.ItemType.ItemType_ChatBubble){\n                    RoleData.ins.avatarInfo.chatBubbles.push(msg.updatedSingleItems[i]);\n                }else if(itemTab.Type===tab.ItemType.ItemType_MainScene){\n                    RoleData.ins.avatarInfo.mainScenes.push(msg.updatedSingleItems[i]);\n                }\n            }\n            RedMgr.refreshEvent(RedDotType.Head_Icon_Red);\n        }\n    }\n\n    addTestData() {\n        let tests: proto.Item[] = [];\n        let item = new proto.Item();\n        item.itemId = 20001;\n        item.num = 20;\n\n        tests.push(item)\n        let item2 = new proto.Item();\n        item2.itemId = 20002;\n        item2.num = 20;\n\n        tests.push(item2);\n        let item3 = new proto.Item();\n        item3.itemId = 20003;\n        item3.num = 5;\n\n        tests.push(item3);\n        let item4 = new proto.Item();\n        item4.itemId = 20004;\n        item4.num = 1;\n\n        tests.push(item4);\n        let item5 = new proto.Item();\n        item5.itemId = 20009;\n        item5.num = 1;\n\n        tests.push(item5)\n        let item6 = new proto.Item();\n        item6.itemId = 20008;\n        item6.num = 1;\n\n        tests.push(item6)\n        let item7 = new proto.Item();\n        item7.itemId = 20010;\n        item7.num = 1;\n\n        tests.push(item7)\n\n        ItemData.ins.adds(tests)\n        // let item8=new proto.Item();\n        // item8.itemId=20012;\n        // item8.num=1;\n        // item8.type=7;\n        // tests.push(item8)\n    }\n\n    on_Red_BagCompose(){\n   \n        let itemList = ItemData.ins.getItems();\n        for (let value of itemList) {\n            let bagType = value.itemTable.BagType;\n            if (bagType == tab.BagType.BagType_Fragment) {\n                let needNum=value.itemTable.DropId[0];\n                if(Number(value.num)>=needNum){\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n    red_hero_Bag() {\n        // 只有碎片跟道具有红点 --- 道具红点->有随机宝箱 碎片红点->可以一件合成\n        let stateToChange = {};\n        let itemList = ItemData.ins.getItems();\n        for (let value of itemList) {\n            let bagType = value.itemTable.BagType;\n            let itemType = value.itemTable.Type\n            if (bagType === tab.BagType.BagType_Goods&&value.num>0) {\n                if (itemType == tab.ItemType.ItemType_Box) {\n                    stateToChange[value.itemId] = true\n                }\n            }\n        }\n        return stateToChange;\n    }\n}"]}