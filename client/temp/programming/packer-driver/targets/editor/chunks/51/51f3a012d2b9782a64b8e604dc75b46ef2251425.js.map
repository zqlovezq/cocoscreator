{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/activity/combine/CombineAccumulatedRechargeItem.ts"],"names":["_decorator","Component","instantiate","Node","Prefab","ScrollView","Vec2","ActivityData","CombineAccumulatedRechargeCellItem","EventMgr","proto","ActivityControl","UIMgr","ViewName","HeroRed","ccclass","property","CombineAccumulatedRechargeItem","activityId","maxLen","onLoad","onMsg","Ptl","GetCumulativeRechargeMapRsp","on_s2c_GetCumulativeRechargeMapRsp","ReceiveCumulativeRechargeRewardRsp","on_s2c_ReceiveCumulativeRechargeRewardRsp","onShow","ins","requesGetCumulativeRecharge","msg","error","code","CommonErrorCode","Succeed","show","viewName","CongratulationPop","data","rewards","setView","Tabs","getAllTabsByRechageId","serverData","getRechargeServerData","node_content","destroyAllChildren","type","getPayType","i","length","ShowId","_tab","getRechargeTabById","console","log","needCount","payAmount","item","pfb_item","itemTs","getComponent","name","String","IndexId","parent","initData","scrollToReward","curLen","getIndex","scroll_view","scrollTo","ids","receivedRewardIds","sort","count"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Node, Prefab, ScrollView, Vec2 } from 'cc';\r\nimport { ActivityData } from '../ActivityData';\r\nimport { ChannelMgr } from '../../../../channel/ChannelMgr';\r\nimport { CombineAccumulatedRechargeCellItem } from './CombineAccumulatedRechargeCellItem';\r\nimport { tab } from '../../../../Table/table_gen';\r\nimport { EventMgr } from '../../../mgr/EventMgr';\r\nimport { proto } from 'client_protocol';\r\nimport { ActivityControl } from '../ActivityControl';\r\nimport { UIMgr } from '../../../mgr/UIMgr';\r\nimport { ViewName } from '../../../define/ViewDefine';\r\nimport { HeroRed } from '../../hero/herobag/HeroRed';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('CombineAccumulatedRechargeItem')\r\nexport class CombineAccumulatedRechargeItem extends Component {\r\n    @property(Prefab)\r\n    pfb_item: Prefab = null;\r\n    @property(Node)\r\n    node_content: Node = null;\r\n    @property(ScrollView)\r\n    scroll_view:ScrollView = null;\r\n    private activityId:number = 0;\r\n    private maxLen:number = 0;\r\n    protected onLoad(): void {\r\n        EventMgr.onMsg(proto.Ptl.GetCumulativeRechargeMapRsp, this.on_s2c_GetCumulativeRechargeMapRsp, this);\r\n        EventMgr.onMsg(proto.Ptl.ReceiveCumulativeRechargeRewardRsp , this.on_s2c_ReceiveCumulativeRechargeRewardRsp, this)\r\n    }\r\n    onShow(activityId: number) {\r\n       this.activityId = activityId;\r\n       ActivityControl.ins.requesGetCumulativeRecharge();\r\n    }\r\n    on_s2c_ReceiveCumulativeRechargeRewardRsp(msg: proto.Msg_ReceiveCumulativeRechargeRewardRsp){\r\n        if (!msg.error || msg.error.code == proto.CommonErrorCode.Succeed) {\r\n            UIMgr.ins.show({ viewName: ViewName.CongratulationPop, data: msg.rewards });\r\n            this.onShow(this.activityId);\r\n        }\r\n    }\r\n    on_s2c_GetCumulativeRechargeMapRsp(msg: proto.Msg_GetCumulativeRechargeMapRsp) {\r\n       this.setView();\r\n    }\r\n    setView(){\r\n        this.maxLen = 0;\r\n        const Tabs = ActivityData.ins.getAllTabsByRechageId(this.activityId);\r\n        const serverData = ActivityData.ins.getRechargeServerData(this.activityId);\r\n        this.node_content.destroyAllChildren();\r\n        const type = HeroRed.ins.getPayType();\r\n        for (let i = 0; i < Tabs.length; i++) {\r\n            if (Tabs[i].ShowId) {\r\n                const _tab = ActivityData.ins.getRechargeTabById(Tabs[i].ShowId)\r\n                console.log(_tab);\r\n                const needCount = _tab[type];\r\n                if (serverData.payAmount < needCount) {\r\n                    break;\r\n                }\r\n            }\r\n            const item = instantiate(this.pfb_item);\r\n            const itemTs = item.getComponent(CombineAccumulatedRechargeCellItem);\r\n            item.name = String(Tabs[i].IndexId);\r\n            item.parent = this.node_content;\r\n            itemTs.initData(Tabs[i], type);\r\n            this.maxLen++;\r\n        }\r\n        this.scrollToReward();\r\n    }\r\n    scrollToReward(){\r\n        const Tabs = ActivityData.ins.getAllTabsByRechageId(this.activityId);\r\n        if(Tabs){\r\n            const curLen = this.getIndex();\r\n            this.scroll_view.scrollTo(new Vec2(0,1-curLen/this.maxLen),0.2)\r\n        }\r\n    }\r\n    // 获取没有领取的奖励\r\n    getIndex():number{\r\n        const serverData = ActivityData.ins.getRechargeServerData(this.activityId);\r\n        const Tabs = ActivityData.ins.getAllTabsByRechageId(this.activityId);\r\n        const ids = serverData.receivedRewardIds.sort();\r\n        if(ids.length===0||ids[0]!==Tabs[0].IndexId){\r\n            return 0;\r\n        }\r\n        if(ids.length===Tabs.length){\r\n            return Tabs.length;\r\n        }\r\n        let count = 0;\r\n        for(let i=0;i<ids.length;i++){\r\n            count++;\r\n            if(ids[i+1]){\r\n                if(ids[i+1]-ids[i]!==1){\r\n                    return count+1;\r\n                }\r\n            }\r\n        }\r\n        return count+1;\r\n    }\r\n}\r\n\r\n\r\n"]}