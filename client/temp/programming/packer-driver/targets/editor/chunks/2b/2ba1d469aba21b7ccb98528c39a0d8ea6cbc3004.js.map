{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/rareBook/RareBookGacha.ts"],"names":["_decorator","Button","Component","Label","Node","RichText","sp","Sprite","proto","Net","EventMgr","RareBookData","tab","UIMgr","ViewName","LangMgr","ItemData","gachaReplace","AdMgr","RedMgr","RedDotType","RoleData","RecruitType","ccclass","property","RareBookGacha","Skeleton","_recruitEquipMap","Map","_isGacha","onLoad","onMsg","Ptl","GachaRsp","on_s2c_GachaRsp","initView","clear","bookDatas","ins","getBookInfos","i","length","bookData","bookTable","Aptitude","HeroAptitude","HeroAptitude_R","set","itemId","isLock","asyncView","msg","error","code","CommonErrorCode","Succeed","id","showNewBookPop","rewards","showGachaView","refreshEvent","HeroGacha","GachaAds","type","AdType","AdType_Gacha1001","maxCount","getAdCountMaxByType","curCount","getAdCountByType","lbl_progress","string","getCount","lbl_adv_time","node_adv_btn","getComponent","grayscale","interactable","totalCount","drop","data","sum","lbl_desc","getCombineString","gachaTen","sendGacha","gachaOnce","sendAdvWatch","playVideoAd","isAdv","self","gachaTab","getData","GachaTableById","getValue","count","ItemCount","ItemId","itemCount","sendMsg","spine_draw","setAnimation","setCompleteListener","listener","animation","name","Msg_GachaReq","fromAdv","Send","GachaReq","canSendMsg","Book","_rewards","_id","show","viewName","RecruitGetPop","map","showGuaranteeView","event","RareBookGuaranteedPop","itemTab","ItemTableById","Type","ItemType","ItemType_Book","RareBookGetPop","CongratulationPop","showGachaProbabilityView","RareBookProbabilityPop"],"mappings":"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","sourcesContent":["import { _decorator, Button, Component, EventTouch, Label, Node, RichText, sp, Sprite } from 'cc';\r\nimport { proto } from 'client_protocol';\r\nimport { Net } from '../../net/Net';\r\nimport { EventMgr } from '../../mgr/EventMgr';\r\nimport { RareBookData } from './RareBookData';\r\nimport { tab } from '../../../Table/table_gen';\r\nimport { UIMgr } from '../../mgr/UIMgr';\r\nimport { ViewName } from '../../define/ViewDefine';\r\nimport { LangMgr } from '../../mgr/LangMgr';\r\nimport { ItemData } from '../item/ItemData';\r\nimport { gachaReplace } from '../../utils/GameUtil';\r\nimport { AdMgr } from '../AdMgr';\r\nimport { RedMgr } from '../../mgr/RedMgr';\r\nimport { RedDotType } from '../../red/RedDotType';\r\nimport { RoleData } from '../role/RoleData';\r\nimport { RecruitType } from '../../../Common/script/EnumTypeMgr';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('RareBookGacha')\r\nexport class RareBookGacha extends Component {\r\n    @property(Label)\r\n    lbl_progress: Label = null;\r\n    @property(Label)\r\n    lbl_adv_time: Label = null;\r\n    @property(RichText)\r\n    lbl_desc: RichText = null;\r\n    @property(Node)\r\n    node_adv_btn: Node = null;\r\n    @property(sp.Skeleton)\r\n    spine_draw: sp.Skeleton = null;\r\n    public _recruitEquipMap: Map<number, boolean> = new Map();\r\n    private _isGacha: boolean = false\r\n    protected onLoad(): void {\r\n        EventMgr.onMsg(proto.Ptl.GachaRsp, this.on_s2c_GachaRsp, this);\r\n    }\r\n    initView() {\r\n        this._recruitEquipMap.clear();\r\n        const bookDatas = RareBookData.ins.getBookInfos();\r\n        for (let i = 0; i < bookDatas.length; i++) {\r\n            const bookData = bookDatas[i];\r\n            if (bookData.bookTable.Aptitude === tab.HeroAptitude.HeroAptitude_R) {\r\n                this._recruitEquipMap.set(bookData.itemId, bookData.isLock)\r\n            }\r\n        }\r\n        this.asyncView();\r\n    }\r\n    on_s2c_GachaRsp(msg: proto.Msg_GachaRsp) {\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        if (msg.id === 1000) {\r\n            this.showNewBookPop(msg.rewards)\r\n        } else {\r\n            this.showGachaView(msg.rewards, msg.id)\r\n        }\r\n        this._isGacha = false;\r\n        this.asyncView();\r\n        RedMgr.refreshEvent(RedDotType.HeroGacha); //保底抽\r\n        RedMgr.refreshEvent(RedDotType.GachaAds); //广告\r\n    }\r\n    /* 同步一些可变化的信息 */\r\n    asyncView() {\r\n        const type = tab.AdType.AdType_Gacha1001\r\n        const maxCount = AdMgr.ins.getAdCountMaxByType(type);\r\n        const curCount = AdMgr.ins.getAdCountByType(type);\r\n        this.lbl_progress.string = ItemData.ins.getCount(82) + \"/\" + 1000;\r\n        this.lbl_adv_time.string = (maxCount - curCount) + \"/\" + maxCount;\r\n        if (AdMgr.ins.getAdCountByType(type) >= AdMgr.ins.getAdCountMaxByType(type)) {\r\n            this.node_adv_btn.getComponent(Sprite).grayscale = true;\r\n            this.node_adv_btn.getComponent(Button).interactable = false;\r\n        }\r\n\r\n        let totalCount = 10;\r\n        for (let i = 0; i < RoleData.ins.drop.data.length; i++) {\r\n            const data = RoleData.ins.drop.data[i];\r\n            if (data.id == \"book_94\") {\r\n                totalCount = totalCount - data.sum;\r\n                break;\r\n            }\r\n        }\r\n        this.lbl_desc.string = LangMgr.getCombineString(\"ui_rarebook_3\", [totalCount]);\r\n    }\r\n    /* 十连抽 */\r\n    private gachaTen() {\r\n        if (this._isGacha) {\r\n            return\r\n        }\r\n        this.sendGacha(1002);\r\n    }\r\n    /* 单抽 */\r\n    private gachaOnce() {\r\n        if (this._isGacha) {\r\n            return\r\n        }\r\n        this.sendGacha(1001);\r\n    }\r\n    /* 广告抽 */\r\n    sendAdvWatch() {\r\n        const type = tab.AdType.AdType_Gacha1001;\r\n        if (AdMgr.ins.getAdCountByType(type) >= AdMgr.ins.getAdCountMaxByType(type)) {\r\n            return\r\n        }\r\n\r\n\r\n        AdMgr.ins.playVideoAd(tab.AdType.AdType_Gacha1001, () => {\r\n            this.sendGacha(1001, true);\r\n        }, false)\r\n    }\r\n    sendGacha(id: number, isAdv: boolean = false) {\r\n        const self = this;\r\n        const gachaTab = tab.getData().GachaTableById.getValue(id);\r\n        const count = gachaTab.ItemCount;\r\n        const itemId = gachaTab.ItemId;\r\n        const itemCount = ItemData.ins.getCount(itemId);\r\n\r\n        const sendMsg = (() => {\r\n            self._isGacha = true;\r\n            self.spine_draw.setAnimation(0, \"xuanzhuan\", false);\r\n            self.spine_draw.setCompleteListener((listener) => {\r\n                if (listener.animation.name === \"xuanzhuan\") {\r\n                    let msg = new proto.Msg_GachaReq();\r\n                    msg.id = id;\r\n                    msg.fromAdv = isAdv;\r\n                    Net.Send(proto.Ptl.GachaReq, msg);\r\n                }\r\n            })\r\n        })\r\n\r\n        if (!isAdv && itemCount < count) {\r\n            let canSendMsg = gachaReplace(id, RecruitType.Book, sendMsg);\r\n            if (!canSendMsg) {\r\n                return;\r\n            }\r\n        }\r\n        sendMsg();\r\n    }\r\n    /* 显示抽卡界面 */\r\n    showGachaView(_rewards: proto.IItem[], _id: number) {\r\n        UIMgr.ins.show({\r\n            viewName: ViewName.RecruitGetPop, data: {\r\n                rewards: _rewards,\r\n                id: _id,\r\n                type: RecruitType.Book,\r\n                map: this._recruitEquipMap\r\n            }\r\n        });\r\n    }\r\n    /* 显示武器保底抽界面 */\r\n    showGuaranteeView(event: EventTouch, type: string) {\r\n        UIMgr.ins.show({\r\n            viewName: ViewName.RareBookGuaranteedPop\r\n        });\r\n    }\r\n    showNewBookPop(rewards: proto.IItem[]) {\r\n        const self = this;\r\n        const itemTab = tab.getData().ItemTableById.getValue(rewards[0].itemId);\r\n        if (itemTab.Type === tab.ItemType.ItemType_Book) {\r\n            UIMgr.ins.show({\r\n                viewName: ViewName.RareBookGetPop, data: {\r\n                    itemId: rewards[0].itemId\r\n                }\r\n            })\r\n        } else {\r\n            UIMgr.ins.show({\r\n                viewName: ViewName.CongratulationPop, data: rewards\r\n            })\r\n        }\r\n    }\r\n    /* 显示概率公示界面 */\r\n    showGachaProbabilityView(event: EventTouch, type: string) {\r\n        UIMgr.ins.show({viewName:ViewName.RareBookProbabilityPop})\r\n        // UIMgr.ins.show({\r\n        //     viewName: ViewName.RecruitProbabilityPop, data: {\r\n        //         type: RecruitType.Book\r\n        //     }\r\n        // });\r\n    }\r\n}\r\n\r\n\r\n"]}