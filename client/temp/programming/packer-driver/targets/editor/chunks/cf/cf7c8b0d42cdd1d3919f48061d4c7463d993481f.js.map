{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/rareBook/RareBookExchangePop.ts"],"names":["_decorator","Node","ViewPop","ItemInfo","RareBookData","tab","ItemPoolMgr","ShowTips","UIMgr","RareBookControl","EventMgr","proto","ViewName","CommonItem","LangMgr","ccclass","property","RareBookExchangePop","canExchangItems","itemNodes","register","onMsg","Ptl","BookFragmentSwitchRsp","on_s2c_BookFragmentSwitchRsp","onShow","ins","getExchangBookFragments","initView","rewards","key","item","bookfraTab","getData","BookFragmentTableById","getValue","itemId","rwdIds","MaterialIdList","t","Math","floor","num","BaseAmount","k","MaterialCountList","info","find","a","initItemData","push","itemNode","createItem","exchangeNode","getComponent","setShowNum","rewardNode","exchangeSucc","removeItem","putCommonItem","onDisable","onDestroy","unTarget","onClickConfirm","length","getLab","requestBookFragmentSwitch","msg","error","code","CommonErrorCode","Succeed","show","viewName","CongratulationPop","data","onClickHelp"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node } from 'cc';\r\nimport { ViewPop } from '../../../framework/base/ViewPop';\r\nimport { ItemInfo } from '../item/ItemInfo';\r\nimport { RareBookData } from './RareBookData';\r\nimport { tab } from '../../../Table/table_gen';\r\nimport { ItemPoolMgr } from '../item/ItemPoolMgr';\r\nimport { ShowTips, UIMgr } from '../../mgr/UIMgr';\r\nimport { RareBookControl } from './RareBookControl';\r\nimport { EventMgr } from '../../mgr/EventMgr';\r\nimport { proto } from 'client_protocol';\r\nimport { ViewName } from '../../define/ViewDefine';\r\nimport { CommonItem } from '../item/CommonItem';\r\nimport { LangMgr } from '../../mgr/LangMgr';\r\nconst { ccclass, property } = _decorator;\r\n\r\n/**\r\n * \r\n * RareBookExchangePop\r\n * zhudingchao\r\n * Tue May 28 2024 10:49:45 GMT+0800 (中国标准时间)\r\n * db://assets/scripts/logic/model/rareBook/RareBookExchangePop.ts\r\n *\r\n */\r\n\r\n@ccclass('RareBookExchangePop')\r\nexport class RareBookExchangePop extends ViewPop {\r\n    @property(Node)\r\n    exchangeNode: Node = null;\r\n    @property(Node)\r\n    rewardNode: Node = null;\r\n\r\n    private canExchangItems: Array<ItemInfo>;\r\n    private itemNodes: Array<Node>;\r\n\r\n\r\n    register(): void {\r\n        EventMgr.onMsg(proto.Ptl.BookFragmentSwitchRsp, this.on_s2c_BookFragmentSwitchRsp, this);\r\n    }\r\n    onShow(): void {\r\n        this.canExchangItems= RareBookData.ins.getExchangBookFragments();\r\n    \r\n      \r\n        this.itemNodes = [];\r\n        this.initView();\r\n    }\r\n\r\n\r\n    initView() {\r\n        let rewards: Array<ItemInfo> = [];\r\n        for (let key in this.canExchangItems) {\r\n            let item = this.canExchangItems[key];\r\n            let bookfraTab = tab.getData().BookFragmentTableById.getValue(item.itemId)\r\n            let rwdIds = bookfraTab.MaterialIdList;\r\n            let t=Math.floor(item.num/bookfraTab.BaseAmount);\r\n            if(t>=1){\r\n                for (let k in rwdIds) {\r\n                    let num=bookfraTab.MaterialCountList[k]*t;\r\n                    let info = rewards.find(a => a.itemId == rwdIds[k]);\r\n                    if (info) {\r\n                        info.num = info.num + num;\r\n                    } else {\r\n                        info = new ItemInfo();\r\n                        info.initItemData(rwdIds[k], num );\r\n                        rewards.push(info);\r\n                    }\r\n                }\r\n                let itemNode = ItemPoolMgr.ins.createItem(item,this.exchangeNode);\r\n                this.itemNodes.push(itemNode);\r\n                itemNode.getComponent(CommonItem).setShowNum(t*bookfraTab.BaseAmount)\r\n            }\r\n            \r\n\r\n        }\r\n\r\n        for (let key in rewards) {\r\n            let itemNode = ItemPoolMgr.ins.createItem(rewards[key],this.rewardNode);\r\n            this.itemNodes.push(itemNode);\r\n        }\r\n    }\r\n    exchangeSucc() {\r\n      \r\n        this.removeItem();\r\n\r\n    }\r\n    removeItem() {\r\n        for (let key in this.itemNodes) {\r\n            ItemPoolMgr.ins.putCommonItem(this.itemNodes[key]);\r\n        }\r\n        this.itemNodes=[];\r\n    }\r\n     protected onDisable(): void {\r\n        this.removeItem();\r\n    }\r\n    protected onDestroy(): void {\r\n        super.onDestroy();\r\n        EventMgr.unTarget(this);\r\n       \r\n    }\r\n    onClickConfirm() {\r\n        if(this.itemNodes.length==0){\r\n            //ShowTips(\"没有可兑换的残卷\");\r\n            ShowTips(LangMgr.getLab(\"Tips_rarebook_2\"));\r\n        }else{\r\n            RareBookControl.ins.requestBookFragmentSwitch();\r\n        }\r\n       \r\n    }\r\n\r\n    on_s2c_BookFragmentSwitchRsp(msg: proto.Msg_BookFragmentSwitchRsp){\r\n        if(msg.error.code==proto.CommonErrorCode.Succeed){\r\n            this.exchangeSucc();\r\n            UIMgr.ins.show({ viewName: ViewName.CongratulationPop, data: msg.rewards })\r\n\r\n            // RareBookData.ins.updateBook(msg.book as proto.BookData)\r\n        }\r\n    }\r\n    onClickHelp() {\r\n        //ShowTips(\"通用提示界面\")\r\n    }\r\n}"]}