{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/Common/script/ComicControl.ts"],"names":["_decorator","Animation","instantiate","Node","Prefab","AbsControl","LoadResAsync","ResMgr","tab","BattleMainDataControl","Func","Sound","ccclass","property","ComicControl","comicData","comicNode","comicIndex","comicAnimState","comicCanTouch","clickEnd","comicOvercallback","waitEnd","ins","_instance","getComicCondition","stageId","id","isPass","getIsPasstStageByStageId","i","getData","Comic","length","comicTab","ComicUnlock","ComicID","addComic","parenNode","cb","console","log","ComicByComicID","getValue","pfb","prefabName","comic_prefab","name","cocosNodeZIndex","addChild","on","EventType","TOUCH_START","touchComic","playAnim","comic_anim_node","getChildByName","NodeName","clearTimeout","releaseComic","active","time","duration","sample","pause","self","comic_anim_name","AnimationName","anim","getComponent","play","getState","FINISHED","e","setTimeout","resume","off","destroy","release"],"mappings":"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","sourcesContent":["/*\r\n * @Date: 2024-10-09 10:34:05\r\n * @LastEditors: wzq\r\n * @pragram:漫画控制组件\r\n * @LastEditTime: 2024-10-25 14:53:57\r\n */\r\n\r\nimport { _decorator, Component, director, Animation, instantiate, Node, Prefab, EventTouch } from 'cc';\r\nimport { AbsControl } from '../../framework/base/IAbs';\r\nimport { LoadResAsync, ResMgr } from '../../logic/mgr/ResMgr';\r\nimport { tab } from '../../Table/table_gen';\r\nimport { UIMgr } from '../../logic/mgr/UIMgr';\r\nimport { BattleMainDataControl } from '../../logic/model/home/battle/BattleMainDataControl';\r\nimport { Func } from '../../logic/utils/Func';\r\nimport Sound from '../../logic/utils/Sound';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ComicControl')\r\nexport class ComicControl extends AbsControl {\r\n    private comicData: tab.Comic = null;\r\n    private comicNode: Node = null;\r\n    private comicIndex: number = -1;\r\n    private comicAnimState = null;\r\n    private comicCanTouch: boolean = true;\r\n    private clickEnd = false;\r\n    private comicOvercallback: Function = null;\r\n    private waitEnd: any = null;\r\n    private static _instance: ComicControl;\r\n    public static get ins() {\r\n        if (null == this._instance) {\r\n            this._instance = new ComicControl();\r\n        }\r\n        return this._instance;\r\n    }\r\n    getComicCondition(stageId: number) {\r\n        let id = 0;\r\n        const isPass = BattleMainDataControl.ins.getIsPasstStageByStageId(stageId);\r\n        if(!isPass){\r\n            return id;\r\n        }\r\n        for (let i = 0; i < tab.getData().Comic.length; i++) {\r\n            const comicTab: tab.Comic = tab.getData().Comic[i];\r\n            if (comicTab.ComicUnlock === stageId) {\r\n                id = comicTab.ComicID;\r\n            }\r\n        }\r\n        return id;\r\n    }\r\n    /* 当前场景添加漫画节点 播放完之后再场景中删除 */\r\n    async addComic(id: number, parenNode: Node, cb?: Function) {\r\n        console.log(\"cocos 当前播放的漫画id=\", id);\r\n        this.comicOvercallback = null;\r\n        if (cb) {\r\n            this.comicOvercallback = cb;\r\n        }\r\n        this.comicCanTouch = true;\r\n        this.comicIndex = 0;\r\n        this.comicData = tab.getData().ComicByComicID.getValue(id);\r\n        let pfb: Prefab = await LoadResAsync(this.comicData.prefabName, Prefab);\r\n        const comic_prefab = instantiate(pfb);\r\n        comic_prefab.name = \"comic\"\r\n        Func.cocosNodeZIndex(comic_prefab, 9999);\r\n        this.comicNode = comic_prefab;\r\n        parenNode.addChild(comic_prefab);\r\n        \r\n        this.comicNode.on(Node.EventType.TOUCH_START, this.touchComic, this);\r\n        this.playAnim();\r\n    }\r\n    touchComic() {\r\n        if (this.clickEnd) {\r\n            const comic_anim_node = this.comicNode.getChildByName(this.comicData.NodeName[this.comicIndex - 1]);\r\n            if (this.comicIndex === this.comicData.NodeName.length) {\r\n                clearTimeout(this.waitEnd);\r\n                this.releaseComic();\r\n            } else {\r\n                clearTimeout(this.waitEnd);\r\n                comic_anim_node.active = false;\r\n                this.playAnim();\r\n            }\r\n        } else {\r\n            if (this.comicAnimState && this.comicCanTouch) {\r\n                this.comicCanTouch = false;\r\n                // 将当前时间设为动画的时长，这样就跳到了最后一帧\r\n                this.comicAnimState.time = this.comicAnimState.duration;\r\n                this.comicAnimState.sample();  // 强制更新动画到当前帧\r\n            }\r\n        }\r\n    }\r\n    // 播放动画\r\n    playAnim() {\r\n        if (this.comicIndex == 0){\r\n            Sound.ins.pause()\r\n        }\r\n        // 节点名字\r\n        var self = this;\r\n        this.clickEnd = false;\r\n        this.waitEnd = null;\r\n        this.comicCanTouch = true;\r\n        const comic_anim_node = this.comicNode.getChildByName(this.comicData.NodeName[this.comicIndex]);\r\n        // 动画名字\r\n        const comic_anim_name = this.comicData.AnimationName[this.comicIndex];\r\n        const anim: Animation = comic_anim_node.getComponent(Animation)\r\n        anim.play(comic_anim_name);\r\n        this.comicAnimState = anim.getState(comic_anim_name);\r\n        anim.on(Animation.EventType.FINISHED, e => {\r\n            console.log(\"cocos 动画播放完---\", comic_anim_name);\r\n            self.comicIndex++;\r\n            self.comicCanTouch = false;\r\n            self.clickEnd = true;\r\n            if (self.comicIndex === self.comicData.NodeName.length) {\r\n                // 漫画结束结束\r\n                console.log(\"cocos 漫画结束结束--- 释放资源\");\r\n                self.waitEnd = setTimeout(() => {\r\n                    self.releaseComic();\r\n                }, 3000)\r\n            } else {\r\n                self.waitEnd = setTimeout(() => {\r\n                    comic_anim_node.active = false;\r\n                    self.playAnim();\r\n                }, 3000)\r\n            }\r\n        })\r\n    }\r\n    releaseComic() {\r\n        Sound.ins.resume()\r\n        this.comicNode.off(Node.EventType.TOUCH_START, this.touchComic, this);\r\n        this.comicNode.destroy();\r\n        this.comicNode = null;\r\n        ResMgr.release(this.comicData.prefabName, Prefab);\r\n        if (this.comicOvercallback) {\r\n            this.comicOvercallback();\r\n        }\r\n    }\r\n}\r\n\r\n\r\n"]}