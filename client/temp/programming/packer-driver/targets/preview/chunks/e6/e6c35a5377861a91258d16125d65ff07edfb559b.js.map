{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/fincaFight/FincaFightStageView.ts"],"names":["_decorator","ViewPop","HeroDataControl","DEVELOPTYPE","FincaFightStageViewHero","FincaFightStageViewBook","FincaFightData","ShowTips","UIMgr","LangMgr","ViewName","FincaFightControl","CommonTipsPop","EventMgr","proto","RedMgr","RedDotType","deepClone","ccclass","property","FincaFightStageView","refreshMainView","view_type","NONE","serverHeroIds","serverBookIds","onShow","HERO","ins","heroIds","bookIds","refreshEvent","PVP_Fight_Team","setView","onClose","self","getLab","checkBookChange","reqSetFincaBattleHeroIds","show","viewName","FincaFightView","checkTeamChange","create","val","change","i","length","getHeroEmptyIndex","register","onMsg","Ptl","SetFincaBattleHeroIdsRsp","on_s2c_SetFincaBattleHeroIdsRsp","SetFincaBattleBookIdsRsp","on_s2c_SetFincaBattleBookIdsRsp","onDestroy","refreshBagData","unRegister","switchView","event","Number","node_hero","node","active","node_book","BOOK","initData","msg","error","code","CommonErrorCode","Succeed"],"mappings":"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","sourcesContent":["import { _decorator, Component, EventTouch, instantiate, Node } from 'cc';\r\nimport { ViewPop } from '../../../framework/base/ViewPop';\r\nimport { HeroDataControl } from '../hero/herobag/HeroDataControl';\r\nimport { DEVELOPTYPE, FincaFightTeamState } from '../../../Common/script/EnumTypeMgr';\r\nimport { FincaFightStageViewHero } from './FincaFightStageViewHero';\r\nimport { FincaFightStageViewBook } from './FincaFightStageViewBook';\r\nimport { FincaFightData } from './FincaFightData';\r\nimport { ShowTips, UIMgr } from '../../mgr/UIMgr';\r\nimport { LangMgr } from '../../mgr/LangMgr';\r\nimport { ViewName } from '../../define/ViewDefine';\r\nimport { FincaFightControl } from './FincaFightControl';\r\nimport { CommonTipsPop } from '../common/CommonTipsPop';\r\nimport { EventMgr } from '../../mgr/EventMgr';\r\nimport { proto } from 'client_protocol';\r\nimport { RedMgr } from '../../mgr/RedMgr';\r\nimport { RedDotType } from '../../red/RedDotType';\r\nimport { deepClone } from '../../utils/GameUtil';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('FincaFightStageView')\r\nexport class FincaFightStageView extends ViewPop {\r\n    @property(FincaFightStageViewHero)\r\n    node_hero: FincaFightStageViewHero = null;\r\n    @property(FincaFightStageViewBook)\r\n    node_book: FincaFightStageViewBook = null;\r\n\r\n    private refreshMainView: Boolean = false;\r\n    private view_type: DEVELOPTYPE = DEVELOPTYPE.NONE;\r\n    private serverHeroIds: number[] = [];\r\n    private serverBookIds: number[] = [];\r\n    onShow(): void {\r\n        this.view_type = DEVELOPTYPE.HERO;\r\n        this.serverHeroIds = deepClone(FincaFightData.ins.heroIds);\r\n        this.serverBookIds = deepClone(FincaFightData.ins.bookIds);\r\n        this.refreshMainView = !FincaFightData.ins.heroIds[0];\r\n        RedMgr.refreshEvent(RedDotType.PVP_Fight_Team);\r\n        this.setView();\r\n    }\r\n    onClose(): void {\r\n        var self = this;\r\n        if (!FincaFightData.ins.heroIds[0]) {\r\n            ShowTips(LangMgr.getLab(\"Tips_finca_1\"));\r\n        } else {\r\n            this.checkBookChange();\r\n            if (self.refreshMainView) {\r\n                FincaFightControl.ins.reqSetFincaBattleHeroIds(FincaFightData.ins.heroIds);\r\n                super.onClose();\r\n                UIMgr.ins.show({ viewName: ViewName.FincaFightView })\r\n            } else {\r\n                // 判断阵容是否发生变动\r\n                if (self.checkTeamChange()) {\r\n                    // 添加一个弹窗\r\n                    CommonTipsPop.create(self.checkTeamChange(), ((val) => {\r\n                        if (val) {\r\n                            if (FincaFightData.ins.heroIds[0]) {\r\n                                FincaFightControl.ins.reqSetFincaBattleHeroIds(FincaFightData.ins.heroIds);\r\n                                super.onClose();\r\n                            } else {\r\n                                // 至少上个战士\r\n                                ShowTips(LangMgr.getLab(\"Tips_finca_1\"))\r\n                            }\r\n                        } else {\r\n                            FincaFightData.ins.heroIds = self.serverHeroIds;\r\n                            super.onClose();\r\n                        }\r\n                    }))\r\n                } else {\r\n                    super.onClose();\r\n                }\r\n            }\r\n        }\r\n    }\r\n    checkBookChange(){\r\n        let change = false;\r\n        for (let i = 0; i < this.serverBookIds.length; i++) {\r\n            if (this.serverBookIds[i] !== FincaFightData.ins.bookIds[i]) {\r\n                change = true;\r\n            }\r\n        }\r\n        if(change){\r\n            FincaFightData.ins.bookIds = deepClone(this.serverBookIds);\r\n        }\r\n    }\r\n    checkTeamChange() {\r\n        if (FincaFightData.ins.getHeroEmptyIndex()) {\r\n            // 还有未上阵英雄\r\n            return LangMgr.getLab(\"Tips_finca_6\")\r\n        } else {\r\n            // 阵容发生变化\r\n            let change = false;\r\n            for (let i = 0; i < this.serverHeroIds.length; i++) {\r\n                if (this.serverHeroIds[i] !== FincaFightData.ins.heroIds[i]) {\r\n                    change = true;\r\n                }\r\n            }\r\n            if (change) {\r\n                return LangMgr.getLab(\"Tips_finca_5\")\r\n            } else {\r\n                return \"\"\r\n            }\r\n        }\r\n    }\r\n    register(): void {\r\n        EventMgr.onMsg(proto.Ptl.SetFincaBattleHeroIdsRsp, this.on_s2c_SetFincaBattleHeroIdsRsp, this);\r\n        EventMgr.onMsg(proto.Ptl.SetFincaBattleBookIdsRsp, this.on_s2c_SetFincaBattleBookIdsRsp, this);\r\n    }\r\n    protected onDestroy(): void {\r\n        super.onDestroy()\r\n        HeroDataControl.ins.refreshBagData(0);\r\n    }\r\n    unRegister(): void {\r\n        super.unRegister();\r\n    }\r\n    switchView(event: EventTouch, view_type: string) {\r\n        if (this.view_type === Number(view_type)) {\r\n            return;\r\n        }\r\n        this.view_type = Number(view_type);\r\n        this.setView();\r\n    }\r\n    setView() {\r\n        this.node_hero.node.active = this.view_type === DEVELOPTYPE.HERO;\r\n        this.node_book.node.active = this.view_type === DEVELOPTYPE.BOOK;\r\n        switch (this.view_type) {\r\n            case DEVELOPTYPE.HERO:\r\n                this.node_hero.initData();\r\n                break;\r\n            case DEVELOPTYPE.BOOK:\r\n                this.node_book.initData();\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    on_s2c_SetFincaBattleHeroIdsRsp(msg: proto.Msg_SetFincaBattleHeroIdsRsp) {\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        ShowTips(LangMgr.getLab(\"ui_fincafight_19\"))\r\n        this.serverHeroIds = deepClone(FincaFightData.ins.heroIds);\r\n    }\r\n    on_s2c_SetFincaBattleBookIdsRsp(msg: proto.Msg_SetFincaBattleBookIdsRsp){\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        ShowTips(LangMgr.getLab(\"ui_fincafight_19\"))\r\n        this.serverBookIds = deepClone(FincaFightData.ins.bookIds);\r\n    }\r\n}\r\n\r\n\r\n"]}