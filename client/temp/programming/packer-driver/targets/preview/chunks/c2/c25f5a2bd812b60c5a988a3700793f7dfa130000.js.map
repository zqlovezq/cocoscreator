{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/startScrpit/UpdateView.ts"],"names":["_decorator","Component","game","Label","native","ProgressBar","Global","ccclass","property","UpdateView","_updating","_canRetry","_storagePath","_am","_checkListener","_updateListener","_failCount","versionCompareHandle","cb","onLoad","verLab","string","setCb","_cb","check","loadUpdate","fileUtils","getWritablePath","console","log","getSearchPaths","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","AssetsManager","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","RES_VERSION","getLocalManifest","getVersion","getVersionStr","checkUpdate","setCDNUrl","getHotUpdateURL","setEventCallback","checkCb","bind","event","getEventCode","isGame","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","NEW_VERSION_FOUND","bar","node","active","setProgress","hotUpdate","progress","progressStr","toFixed","lab","updateCb","update","needRestart","failed","UPDATE_PROGRESSION","getPercent","UPDATE_FINISHED","UPDATE_FAILED","retry","ERROR_UPDATING","getAssetId","getMessage","ERROR_DECOMPRESS","restart","downloadFailedAssets"],"mappings":"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","sourcesContent":["import { _decorator, assetManager, BlockInputEvents, Button, Color, Component, director, game, instantiate, Label, Layers, native, Node, Prefab, ProgressBar, ResolutionPolicy, Sprite, tween, UITransform, Vec3, view } from 'cc';\nimport { JSB } from 'cc/env';\nimport { Global } from './Global';\nimport { Trigger } from '../scripts/framework/collision/CollisionObject';\n\nconst { ccclass, property } = _decorator;\n\n\n@ccclass('UpdateView')\nexport class UpdateView extends Component {\n\n    @property(ProgressBar)\n    bar: ProgressBar = null\n\n    @property(Label)\n    lab: Label = null\n\n    @property(Label)\n    verLab: Label = null\n\n    private _updating = false;\n    private _canRetry = false;\n    private _storagePath = '';\n    private _am: native.AssetsManager = null!;\n    private _checkListener = null;\n    private _updateListener = null;\n    private _failCount = 0;\n    private versionCompareHandle: (versionA: string, versionB: string) => number = null!;\n\n    cb: Function\n    protected onLoad(): void {\n        this.verLab.string = \"\"\n    }\n\n    setCb(_cb: Function) {\n        this.cb = _cb\n    }\n\n    check() {\n        this.loadUpdate()\n    }\n\n\n    loadUpdate() {\n\n        this._storagePath = ((native.fileUtils ? native.fileUtils.getWritablePath() : '/') + 'newUpdate');\n        console.log('Storage path for remote asset : ' + this._storagePath);\n        console.log(\"当前搜索路径\", native.fileUtils.getSearchPaths())\n        // // Setup your own version compare handler, versionA and B is versions in string\n        // // if the return value greater than 0, versionA is greater than B,\n        // // if the return value equals 0, versionA equals to B,\n        // // if the return value smaller than 0, versionA is smaller than B.\n        this.versionCompareHandle = function (versionA: string, versionB: string) {\n            console.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\n            var vA = versionA.split('.');\n            var vB = versionB.split('.');\n            for (var i = 0; i < vA.length; ++i) {\n                var a = parseInt(vA[i]);\n                var b = parseInt(vB[i] || '0');\n                if (a === b) {\n                    continue;\n                }\n                else {\n                    return a - b;\n                }\n            }\n            if (vB.length > vA.length) {\n                return -1;\n            }\n            else {\n                return 0;\n            }\n        };\n\n        // // Init with empty manifest url for testing custom manifest\n        this._am = new native.AssetsManager('version/project.manifest', this._storagePath, this.versionCompareHandle);\n\n        // // Setup the verification callback, but we don't have md5 check function yet, so only print some message\n        // // Return true if the verification passed, otherwise return false\n        this._am.setVerifyCallback(function (path: string, asset: any) {\n            // // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\n            var compressed = asset.compressed;\n            // // Retrieve the correct md5 value.\n            var expectedMD5 = asset.md5;\n            // // asset.path is relative path and path is absolute.\n            var relativePath = asset.path;\n            // // The size of asset file, but this value could be absent.\n            var size = asset.size;\n            if (compressed) {\n                return true;\n            }\n            else {\n                return true;\n            }\n        });\n        Global.RES_VERSION = this._am.getLocalManifest().getVersion()\n        this.verLab.string = Global.getVersionStr()\n        this.checkUpdate()\n    }\n\n    checkUpdate() {\n        if (this._updating) {\n            return;\n        }\n\n        this._am.setCDNUrl(Global.getHotUpdateURL())\n        this._am.setEventCallback(this.checkCb.bind(this));\n\n        this._am.checkUpdate();\n        this._updating = true;\n    }\n\n    checkCb(event: any) {\n        console.log('Code: ' + event.getEventCode());\n        var isGame = false\n        switch (event.getEventCode()) {\n            case native.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                // //下载清单文件失败，跳过热更新。\n                isGame = true\n                console.log(\"找不到本地清单文件，跳过了热更新。\")\n                break;\n            case native.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case native.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                isGame = true\n                console.log(\"下载清单文件失败，跳过热更新。\")\n                break;\n            case native.EventAssetsManager.ALREADY_UP_TO_DATE:\n                // //已经更新了最新的远程版本。\n                isGame = true\n                console.log(\"已经更新了最新的远程版本。\")\n                break;\n            case native.EventAssetsManager.NEW_VERSION_FOUND:\n                // //可以开始更新游戏\n                console.log(\"可以开始更新游戏\")\n                this.bar.node.active = true\n                this.setProgress(0.01)\n                isGame = false\n                break;\n            default:\n                return;\n        }\n\n        this._am.setEventCallback(null!);\n        this._checkListener = null;\n        this._updating = false;\n        if (isGame) {\n            this.cb()\n        } else {\n            this.hotUpdate()\n        }\n    }\n\n    setProgress(progress: number) {\n        let progressStr = (progress * 100).toFixed(2) + '%'\n        this.bar.progress = progress\n        this.lab.string = progressStr\n    }\n\n    hotUpdate() {\n        if (this._am && !this._updating) {\n            this._am.setEventCallback(this.updateCb.bind(this));\n\n            this._failCount = 0;\n            this._am.update();\n            this._updating = true;\n        }\n    }\n\n    updateCb(event: any) {\n        var needRestart = false;\n        var failed = false;\n        switch (event.getEventCode()) {\n            case native.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                console.log('找不到本地清单文件，跳过了热更新。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.UPDATE_PROGRESSION:\n                // //更新中\n                this.setProgress(event.getPercent())\n                break;\n            case native.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n            case native.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                console.log('下载清单文件失败，跳过热更新。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.ALREADY_UP_TO_DATE:\n                console.log('已经更新了最新的远程版本。')\n                failed = true;\n                break;\n            case native.EventAssetsManager.UPDATE_FINISHED:\n                // //更新完成\n                console.log('更新完成')\n                needRestart = true;\n                break;\n            case native.EventAssetsManager.UPDATE_FAILED:\n                // //更新失败 可以尝试再次更新\n                console.log('更新失败 可以尝试再次更新')\n                this._updating = false;\n                this._canRetry = true;\n                this.retry()\n                break;\n            case native.EventAssetsManager.ERROR_UPDATING:\n                // //资源更新错误\n                console.log('资源更新错误: ' + event.getAssetId() + ', ' + event.getMessage())\n                break;\n            case native.EventAssetsManager.ERROR_DECOMPRESS:\n                // //解压时出错\n                console.log('解压时出错')\n                break;\n            default:\n                break;\n        }\n\n        if (failed) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            this._updating = false;\n        }\n\n        if (needRestart) {\n            this._am.setEventCallback(null!);\n            this._updateListener = null;\n            game.restart()\n            //热更完成\n        }\n    }\n\n    retry() {\n        if (!this._updating && this._canRetry) {\n            this._canRetry = false;\n\n            this.lab.string = \"重试失败的文件\"\n            this._am.downloadFailedAssets();\n        }\n    }\n}\n\n"]}