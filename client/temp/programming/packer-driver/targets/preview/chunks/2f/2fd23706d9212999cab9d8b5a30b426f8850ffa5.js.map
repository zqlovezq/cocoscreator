{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/hero/herobag/HeroStarSpecialPop.ts"],"names":["_decorator","instantiate","Label","Node","Prefab","Sprite","ViewPop","HeroMaterialItem","Func","tab","HeroData","HeroDataControl","proto","Net","ItemData","LangMgr","EventMgr","LocalEvent","ccclass","property","HeroStarSpecialPop","_step","_heroInfo","_herosMaterialMap","Map","register","onLocal","Hero_Material_Select","refeshMaterial","data","setHerosMaterialById","initData","onShow","openData","stepId","ins","getById","heroId","setHerosMaterialMap","onDestroy","node_stuff_star_layout","destroyAllChildren","starTab","getData","HeroStarStepTableById","getValue","node_show","active","finshedStarSteps","indexOf","rich_text_attr","string","getLab","StepDesc","i","HeroStarUpType","length","type","item","pfb_hero_material","name","parent","cocosNodeZIndex","itemTs","getComponent","heroClass","heroClassTable","HeroClass","HeroStarUpType_AnyHero","HeroClass_Any","setMaterial","itemIds","CostItemId","counts","CostItemNum","sp_item","node","k","_ItemData","getByItemId","itemTab","ItemTableById","num","lbl_item","setTexture","Icon","clickHeroStarStepUp","MaterialEnough","checkStarUpMaterialEnough","console","log","msg","Msg_FinishHeroStarStepReq","map","getHerosMaterialMap","upStarCosts","_type","_count","CostHeroNum","getHerosMaterialMapCount","obj","costType","costHeroIds","costItems","push","forEach","value","key","heroCost","itemId","hasItemIndex","id","Send","Ptl","FinishHeroStarStepReq"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Label, Node, Prefab, RichText, Sprite } from 'cc';\r\nimport { ViewPop } from '../../../../framework/base/ViewPop';\r\nimport { HeroMaterialItem } from './HeroMaterialItem';\r\nimport { Func } from '../../../utils/Func';\r\nimport { tab } from '../../../../Table/table_gen';\r\nimport { HeroInfo, materialHeros } from '../HeroInfo';\r\nimport { HeroData } from '../HeroData';\r\nimport { HeroDataControl } from './HeroDataControl';\r\nimport { proto } from 'client_protocol';\r\nimport { Net } from '../../../net/Net';\r\nimport { ItemData } from '../../item/ItemData';\r\nimport { LangMgr } from '../../../mgr/LangMgr';\r\nimport { EventMgr } from '../../../mgr/EventMgr';\r\nimport { LocalEvent } from '../../../define/LocalEvent';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('HeroStarSpecialPop')\r\nexport class HeroStarSpecialPop extends ViewPop {\r\n    private _step: number = 0;\r\n    @property(Prefab)\r\n    pfb_hero_material: Prefab = null;\r\n    @property(Node)\r\n    node_stuff_star_layout: Node = null;\r\n    @property(Node)\r\n    node_show: Node = null;\r\n    @property(Sprite)\r\n    sp_item: Sprite = null;\r\n    @property(Label)\r\n    lbl_item: Label = null;\r\n    @property(Label)\r\n    rich_text_attr: RichText = null;\r\n    private _heroInfo: HeroInfo = null;\r\n    private _herosMaterialMap: Map<number, materialHeros> = new Map();\r\n    register(): void {\r\n        EventMgr.onLocal(LocalEvent.Hero_Material_Select, this.refeshMaterial, this);\r\n    }\r\n    refeshMaterial(data) {\r\n        if(data){\r\n            this._heroInfo.setHerosMaterialById(data[0], data[1], data[2], data[3] ? data[3] : null);\r\n        }\r\n        this.initData();\r\n    }\r\n    onShow(): void {\r\n        this._step = this.openData.stepId;\r\n        this._heroInfo = HeroData.ins.getById(HeroDataControl.ins.heroId);\r\n        this._herosMaterialMap = this._heroInfo.setHerosMaterialMap(this._step);\r\n        this.initData();\r\n    }\r\n    onDestroy(): void {\r\n        super.onDestroy();\r\n    }\r\n    initData() {\r\n        this.node_stuff_star_layout.destroyAllChildren();\r\n        let starTab = tab.getData().HeroStarStepTableById.getValue(this._step);\r\n        this.node_show.active = this._heroInfo.finshedStarSteps.indexOf(this._step) === -1;\r\n        this.rich_text_attr.string = LangMgr.getLab(starTab.StepDesc);\r\n        if(this.node_show.active){\r\n            for (let i = 0; i < starTab.HeroStarUpType.length; i++) {\r\n                let type: tab.HeroStarUpType = starTab.HeroStarUpType[i];\r\n                let item = instantiate(this.pfb_hero_material);\r\n                item.name = \"item\" + type;\r\n                item.parent = this.node_stuff_star_layout;\r\n                Func.cocosNodeZIndex(item, type);\r\n                item.active = true;\r\n                let itemTs: HeroMaterialItem = item.getComponent(HeroMaterialItem)\r\n                let heroClass = this._heroInfo.heroClassTable.HeroClass;\r\n                if (type == tab.HeroStarUpType.HeroStarUpType_AnyHero) {\r\n                    heroClass = tab.HeroClass.HeroClass_Any\r\n                }\r\n                itemTs.setMaterial(type, heroClass, this._step);\r\n            }\r\n            /* 升级所需的材料 */\r\n            let itemIds = starTab.CostItemId;\r\n            let counts = starTab.CostItemNum;\r\n            this.sp_item.node.parent.active = itemIds.length > 0;\r\n            for (let k = 0; k < itemIds.length; k++) {\r\n                let _ItemData = ItemData.ins.getByItemId(itemIds[k]);\r\n                let itemTab = tab.getData().ItemTableById.getValue(itemIds[k]);\r\n                if (_ItemData && _ItemData.num) {\r\n                    this.lbl_item.string = _ItemData.num + \" / \" + counts[k];\r\n                } else {\r\n                    this.lbl_item.string = 0 + \" / \" + counts[k];\r\n                }\r\n                this.sp_item.setTexture(itemTab.Icon);\r\n            }\r\n        }\r\n    }\r\n    /* 进阶 */\r\n    clickHeroStarStepUp() {\r\n        let MaterialEnough = this._heroInfo.checkStarUpMaterialEnough(this._step);\r\n        if (!MaterialEnough) {\r\n            console.log(\"cocos 材料不足\")\r\n            return;\r\n        }\r\n        let msg = new proto.Msg_FinishHeroStarStepReq()\r\n        const map = this._heroInfo.getHerosMaterialMap();\r\n        let starTab = tab.getData().HeroStarStepTableById.getValue(this._step)\r\n        let upStarCosts: proto.IUpHeroStarCost[] = []\r\n        for (let i = 0; i < starTab.HeroStarUpType.length; i++) {\r\n            let _type: tab.HeroStarUpType = starTab.HeroStarUpType[i];\r\n            let _count: number = starTab.CostHeroNum[i];\r\n            if (this._heroInfo.getHerosMaterialMapCount(_type) < _count) {\r\n                console.log(`cocos type=${_type} 需要的数量为${_count} 当前的数量为${this._heroInfo.getHerosMaterialMapCount(_type)}`)\r\n                return\r\n            }\r\n            let obj: proto.IUpHeroStarCost = {\r\n                costType: _type,\r\n                costHeroIds: [],\r\n                costItems: []\r\n            }\r\n            upStarCosts.push(obj);\r\n        }\r\n        map.forEach((value, key) => {\r\n            let heroCost: proto.IUpHeroStarCost = null;\r\n            for (let i = 0; i < upStarCosts.length; i++) {\r\n                if (value.type === upStarCosts[i].costType) {\r\n                    heroCost = upStarCosts[i]\r\n                }\r\n            }\r\n            let costHeroIds = heroCost.costHeroIds;\r\n            let costItems = heroCost.costItems;\r\n            if (value.itemId) {\r\n                if (costItems.length > 0) {\r\n                    let hasItemIndex = -1\r\n                    for (let i = 0; i < costItems.length; i++) {\r\n                        if (costItems[i].itemId === value.itemId) {\r\n                            hasItemIndex = i;\r\n                        }\r\n                    }\r\n                    if(hasItemIndex>=0){\r\n                        costItems[hasItemIndex].num++;\r\n                    }else{\r\n                        costItems.push({\r\n                            itemId: value.itemId,\r\n                            num: 1\r\n                        })\r\n                    }\r\n                } else {\r\n                    costItems.push({\r\n                        itemId: value.itemId,\r\n                        num: 1\r\n                    })\r\n                }\r\n            } else {\r\n                costHeroIds.push(key);\r\n            }\r\n        })\r\n        msg.stepId = this._step;\r\n        msg.heroId = this._heroInfo.id;\r\n        msg.upStarCosts = upStarCosts;\r\n        Net.Send(proto.Ptl.FinishHeroStarStepReq, msg)\r\n    }\r\n}\r\n\r\n\r\n"]}