{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/fincaFight/FincaFightStageViewBook.ts"],"names":["_decorator","Component","instantiate","Node","Prefab","Toggle","Vec2","tab","InfiniteList","RareBookData","FincaFightStageWeaponLayoutItem","EventMgr","LocalEvent","FincaFightBookToggle","FincaFightData","FincaFightTeamState","WeaponInfoItem","ButtonLock","moveZeroes","FincaFightControl","proto","ccclass","property","FincaFightStageViewBook","_list","_vocationType","HeroClass","HeroClass_Any","_lineHeroCount","onLoad","onLocal","Finca_Book_Change","teamBookChange","onMsg","Ptl","SetFincaBattleBookIdsRsp","on_s2c_SetFincaBattleBookIdsRsp","index","teamToggleArray","setData","checkEmpty","showBookView","updateWeaponInfoItem","_emptyIndex","ins","getBookEmptyIndex","onClickTeamToggle","String","_toggle","node","getComponent","isChecked","curSelectBook","bookIds","initData","i","length","v","BookToggleIndex","vocationToggleNode","getChildByName","groupBookList","result","bookList","getBookList","get","push","slice","isInit","list_books","Init","getCellNumber","getCellCount","bind","getCellSize","getCellHeight","getCellIdentifer","getCellView","getCellData","GetCellData","Refresh","scrollToOffset","pfb_book_item","idx","switchVocation","event","vocationType","Number","curIndex","getBookState","LOCK","node_no_weapon","active","bookInfo","getBookInfoByItemId","setShowStar","bookTable","Aptitude","HeroAptitude","HeroAptitude_SR","onClickSaveTeam","reqSetFincaBattleBookIds","msg","error","code","CommonErrorCode","Succeed"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAuBC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,I,OAAAA,I;;AACtEC,MAAAA,G,iBAAAA,G;;AACFC,MAAAA,Y;;AACEC,MAAAA,Y,iBAAAA,Y;;AACAC,MAAAA,+B,iBAAAA,+B;;AAEAC,MAAAA,Q,iBAAAA,Q;;AACAC,MAAAA,U,iBAAAA,U;;AACAC,MAAAA,oB,iBAAAA,oB;;AACAC,MAAAA,c,iBAAAA,c;;AACAC,MAAAA,mB,kBAAAA,mB;;AACAC,MAAAA,c,kBAAAA,c;;AACAC,MAAAA,U,kBAAAA,U;AAAYC,MAAAA,U,kBAAAA,U;;AACZC,MAAAA,iB,kBAAAA,iB;;AACAC,MAAAA,K,oBAAAA,K;;;;;;;;;OACH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBtB,U;;yCAGjBuB,uB,WADZF,OAAO,CAAC,yBAAD,C,UAEHC,QAAQ;AAAA;AAAA,uC,UAERA,QAAQ,CAAClB,MAAD,C,UAERkB,QAAQ,CAACnB,IAAD,C,UAERmB,QAAQ,CAAC;AAAA;AAAA,uDAAD,C,UAERA,QAAQ;AAAA;AAAA,2C,UAERA,QAAQ,CAACnB,IAAD,C,UAkHR;AAAA;AAAA,oCAAW,CAAX,EAAc,MAAM,CAAG,CAAvB,C,2BA9HL,MACaoB,uBADb,SAC6CtB,SAD7C,CACuD;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAa3CuB,KAb2C,GAanC,EAbmC;AAAA,eAc3CC,aAd2C,GAc3B;AAAA;AAAA,0BAAIC,SAAJ,CAAcC,aAda;AAAA,eAe3CC,cAf2C,GAe1B,CAf0B;AAAA;;AAgBzCC,QAAAA,MAAM,GAAS;AACrB;AAAA;AAAA,oCAASC,OAAT,CAAiB;AAAA;AAAA,wCAAWC,iBAA5B,EAA+C,KAAKC,cAApD,EAAoE,IAApE;AACA;AAAA;AAAA,oCAASC,KAAT,CAAe;AAAA;AAAA,8BAAMC,GAAN,CAAUC,wBAAzB,EAAmD,KAAKC,+BAAxD,EAAyF,IAAzF;AACH;;AACDJ,QAAAA,cAAc,CAACK,KAAD,EAAgB;AAC1B,eAAKC,eAAL,CAAqBD,KAAK,GAAG,CAA7B,EAAgCE,OAAhC,CAAwCF,KAAK,GAAG,CAAhD;AACA,eAAKG,UAAL;AACA,eAAKC,YAAL,CAAkB,IAAlB;AACA,eAAKC,oBAAL;AACH;;AACDF,QAAAA,UAAU,GAAG;AACT,cAAMG,WAAW,GAAG;AAAA;AAAA,gDAAeC,GAAf,CAAmBC,iBAAnB,EAApB;;AACA,cAAIF,WAAJ,EAAiB;AACb,iBAAKG,iBAAL,CAAuB,IAAvB,EAA6BC,MAAM,CAACJ,WAAD,CAAnC;;AACA,gBAAMK,OAAO,GAAG,KAAKV,eAAL,CAAqBK,WAAW,GAAG,CAAnC,EAAsCM,IAAtC,CAA2CC,YAA3C,CAAwD7C,MAAxD,CAAhB;;AACA2C,YAAAA,OAAO,CAACG,SAAR,GAAoB,IAApB;AACA;AAAA;AAAA,kDAAeP,GAAf,CAAmBQ,aAAnB,GAAmC;AAAA;AAAA,kDAAeR,GAAf,CAAmBS,OAAnB,CAA2BV,WAAW,GAAG,CAAzC,CAAnC;AACH;AACJ;;AACDW,QAAAA,QAAQ,GAAG;AACP,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKjB,eAAL,CAAqBkB,MAAzC,EAAiDD,CAAC,EAAlD,EAAsD;AAClD,gBAAME,CAAC,GAAG,KAAKnB,eAAL,CAAqBiB,CAArB,CAAV;;AACA,gBAAIA,CAAC,KAAK,CAAV,EAAa;AACT;AAAA;AAAA,oDAAeX,GAAf,CAAmBc,eAAnB,GAAqC,CAArC;AACH;;AACDD,YAAAA,CAAC,CAAClB,OAAF,CAAUgB,CAAV;AACH;;AAED,eAAK9B,aAAL,GAAqB;AAAA;AAAA,0BAAIC,SAAJ,CAAcC,aAAnC;;AACA,cAAMqB,OAAO,GAAG,KAAKW,kBAAL,CAAwBC,cAAxB,CAAuC,WAAW,KAAKnC,aAAvD,EAAsEyB,YAAtE,CAAmF7C,MAAnF,CAAhB;;AACA2C,UAAAA,OAAO,CAACG,SAAR,GAAoB,IAApB;AACA,eAAKX,UAAL;AACA,eAAKE,oBAAL;AACA,eAAKD,YAAL,CAAkB,IAAlB;AACH;;AACDoB,QAAAA,aAAa,GAAG;AACZ,cAAMC,MAAM,GAAG,EAAf;AACA,cAAMC,QAAQ,GAAG;AAAA;AAAA,gDAAenB,GAAf,CAAmBoB,WAAnB,GAAiCC,GAAjC,CAAqC,KAAKxC,aAA1C,CAAjB;;AACA,eAAK,IAAI8B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGQ,QAAQ,CAACP,MAA7B,EAAqCD,CAAC,IAAI,KAAK3B,cAA/C,EAA+D;AAC3DkC,YAAAA,MAAM,CAACI,IAAP,CAAYH,QAAQ,CAACI,KAAT,CAAeZ,CAAf,EAAkBA,CAAC,GAAG,KAAK3B,cAA3B,CAAZ;AACH;;AACD,iBAAOkC,MAAP;AACH;;AACDrB,QAAAA,YAAY,CAAC2B,MAAD,EAAkB;AAC1B;AACA,eAAK5C,KAAL,GAAa,KAAKqC,aAAL,EAAb;;AACA,cAAIO,MAAJ,EAAY;AACR,iBAAKC,UAAL,CAAgBC,IAAhB,CAAqB;AACjBC,cAAAA,aAAa,EAAE,KAAKC,YAAL,CAAkBC,IAAlB,CAAuB,IAAvB,CADE;AAEjBC,cAAAA,WAAW,EAAE,KAAKC,aAAL,CAAmBF,IAAnB,CAAwB,IAAxB,CAFI;AAGjBG,cAAAA,gBAAgB,EAAE,KAAKA,gBAAL,CAAsBH,IAAtB,CAA2B,IAA3B,CAHD;AAIjBI,cAAAA,WAAW,EAAE,KAAKA,WAAL,CAAiBJ,IAAjB,CAAsB,IAAtB,CAJI;AAKjBK,cAAAA,WAAW,EAAE,KAAKC,WAAL,CAAiBN,IAAjB,CAAsB,IAAtB;AALI,aAArB;AAOH,WARD,MAQO;AACH,iBAAKJ,UAAL,CAAgBW,OAAhB;AACH;;AACD,eAAKX,UAAL,CAAgBY,cAAhB,CAA+B,IAAI3E,IAAJ,CAAS,CAAT,EAAY,CAAZ,CAA/B,EAA+C,CAA/C,EAAkD,IAAlD;AACH;;AACDkE,QAAAA,YAAY,GAAG;AACX,iBAAO,KAAKhD,KAAL,CAAWgC,MAAlB;AACH;;AACDmB,QAAAA,aAAa,GAAG;AACZ,iBAAO,GAAP;AACH;;AACDC,QAAAA,gBAAgB,GAAG;AACf,iBAAO,iCAAP;AACH;;AACDC,QAAAA,WAAW,GAAG;AACV,iBAAO3E,WAAW,CAAC,KAAKgF,aAAN,CAAX,CAAgChC,YAAhC;AAAA;AAAA,iFAAP;AACH;;AACD6B,QAAAA,WAAW,CAACI,GAAD,EAAc;AACrB,iBAAO,KAAK3D,KAAL,CAAW2D,GAAX,CAAP;AACH;;AACDC,QAAAA,cAAc,CAACC,KAAD,EAAoBC,YAApB,EAA0C;AACpD,cAAI,KAAK7D,aAAL,IAAsB8D,MAAM,CAACD,YAAD,CAAhC,EAAgD;AAC5C;AACH;;AACD,eAAK7D,aAAL,GAAqB8D,MAAM,CAACD,YAAD,CAA3B;AACA,eAAK7C,YAAL,CAAkB,IAAlB;AACH;;AACDK,QAAAA,iBAAiB,CAACuC,KAAD,EAAoBG,QAApB,EAAsC;AACnD,cAAI;AAAA;AAAA,gDAAe5C,GAAf,CAAmBc,eAAnB,KAAuC6B,MAAM,CAACC,QAAD,CAAjD,EAA6D;AACzD;AACH;;AAED,cAAI;AAAA;AAAA,gDAAe5C,GAAf,CAAmB6C,YAAnB,CAAgCF,MAAM,CAACC,QAAD,CAAtC,MAAsD;AAAA;AAAA,0DAAoBE,IAA9E,EAAoF;AAChF,gBAAM1C,OAAO,GAAG,KAAKV,eAAL,CAAqB;AAAA;AAAA,kDAAeM,GAAf,CAAmBc,eAAnB,GAAqC,CAA1D,EAA6DT,IAA7D,CAAkEC,YAAlE,CAA+E7C,MAA/E,CAAhB;;AACA2C,YAAAA,OAAO,CAACG,SAAR,GAAoB,IAApB;AACA;AACH;;AACD;AAAA;AAAA,gDAAeP,GAAf,CAAmBc,eAAnB,GAAqC6B,MAAM,CAACC,QAAD,CAA3C;AACA;AAAA;AAAA,gDAAe5C,GAAf,CAAmBQ,aAAnB,GAAmC;AAAA;AAAA,gDAAeR,GAAf,CAAmBS,OAAnB,CAA2B;AAAA;AAAA,gDAAeT,GAAf,CAAmBc,eAAnB,GAAqC,CAAhE,CAAnC;AACA,eAAKhB,oBAAL;AACA,eAAKD,YAAL,CAAkB,IAAlB;AACH;;AACDC,QAAAA,oBAAoB,GAAG;AACnB,cAAI;AAAA;AAAA,gDAAeE,GAAf,CAAmBQ,aAAvB,EAAsC;AAClC,iBAAKuC,cAAL,CAAoBC,MAApB,GAA6B,KAA7B;AACA,iBAAK5E,cAAL,CAAoBiC,IAApB,CAAyB2C,MAAzB,GAAkC,IAAlC;AACA,gBAAIC,QAAQ,GAAG;AAAA;AAAA,8CAAajD,GAAb,CAAiBkD,mBAAjB,CAAqC;AAAA;AAAA,kDAAelD,GAAf,CAAmBQ,aAAxD,CAAf;AACA,iBAAKpC,cAAL,CAAoBsC,QAApB,CAA6BuC,QAA7B;AACA,iBAAK7E,cAAL,CAAoB+E,WAApB,CAAgCF,QAAQ,CAACG,SAAT,CAAmBC,QAAnB,IAA+B;AAAA;AAAA,4BAAIC,YAAJ,CAAiBC,eAAhF;AACH,WAND,MAMO;AACH,iBAAKR,cAAL,CAAoBC,MAApB,GAA6B,IAA7B;AACA,iBAAK5E,cAAL,CAAoBiC,IAApB,CAAyB2C,MAAzB,GAAkC,KAAlC;AACH;AACJ,SA3HkD,CA4HnD;;;AAEAQ,QAAAA,eAAe,GAAG;AACd;AAAA;AAAA,gDAAexD,GAAf,CAAmBS,OAAnB,GAA6B;AAAA;AAAA,wCAAW;AAAA;AAAA,gDAAeT,GAAf,CAAmBS,OAA9B,CAA7B;AACA;AAAA;AAAA,sDAAkBT,GAAlB,CAAsByD,wBAAtB,CAA+C;AAAA;AAAA,gDAAezD,GAAf,CAAmBS,OAAlE;AACH;;AACDjB,QAAAA,+BAA+B,CAACkE,GAAD,EAA0C;AACrE,cAAIA,GAAG,CAACC,KAAJ,IAAaD,GAAG,CAACC,KAAJ,CAAUC,IAAV,IAAkB;AAAA;AAAA,8BAAMC,eAAN,CAAsBC,OAAzD,EAAkE;;AAClE,eAAK,IAAInD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKjB,eAAL,CAAqBkB,MAAzC,EAAiDD,CAAC,EAAlD,EAAsD;AAClD,gBAAME,CAAC,GAAG,KAAKnB,eAAL,CAAqBiB,CAArB,CAAV;;AACA,gBAAIA,CAAC,KAAK,CAAV,EAAa;AACT;AAAA;AAAA,oDAAeX,GAAf,CAAmBc,eAAnB,GAAqC,CAArC;AACH;;AACDD,YAAAA,CAAC,CAAClB,OAAF,CAAUgB,CAAV;AACH;;AACD,eAAKf,UAAL;AACH;;AA5IkD,O;;;;;iBAExB,I;;;;;;;iBAEH,I;;;;;;;iBAEG,I;;;;;;;iBAEe,E;;;;;;;iBAET,I;;;;;;;iBAEV,I","sourcesContent":["import { _decorator, Component, EventTouch, instantiate, Node, Prefab, Toggle, Vec2 } from 'cc';\r\nimport { tab } from '../../../Table/table_gen';\r\nimport InfiniteList from '../../../Common/InfiniteList/InfiniteList';\r\nimport { RareBookData } from '../rareBook/RareBookData';\r\nimport { FincaFightStageWeaponLayoutItem } from './FincaFightStageWeaponLayoutItem';\r\nimport { RareBookInfo } from '../rareBook/RareBookInfo';\r\nimport { EventMgr } from '../../mgr/EventMgr';\r\nimport { LocalEvent } from '../../define/LocalEvent';\r\nimport { FincaFightBookToggle } from './FincaFightBookToggle';\r\nimport { FincaFightData } from './FincaFightData';\r\nimport { FincaFightTeamState } from '../../../Common/script/EnumTypeMgr';\r\nimport { WeaponInfoItem } from '../common/WeaponInfoItem';\r\nimport { ButtonLock, moveZeroes } from '../../utils/GameUtil';\r\nimport { FincaFightControl } from './FincaFightControl';\r\nimport { proto } from 'client_protocol';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('FincaFightStageViewBook')\r\nexport class FincaFightStageViewBook extends Component {\r\n    @property(InfiniteList)\r\n    list_books: InfiniteList = null;\r\n    @property(Prefab)\r\n    pfb_book_item: Prefab = null;\r\n    @property(Node)\r\n    vocationToggleNode: Node = null;\r\n    @property([FincaFightBookToggle])\r\n    teamToggleArray: FincaFightBookToggle[] = [];\r\n    @property(WeaponInfoItem)\r\n    WeaponInfoItem: WeaponInfoItem = null;\r\n    @property(Node)\r\n    node_no_weapon: Node = null;\r\n    private _list = []\r\n    private _vocationType = tab.HeroClass.HeroClass_Any;\r\n    private _lineHeroCount = 4;\r\n    protected onLoad(): void {\r\n        EventMgr.onLocal(LocalEvent.Finca_Book_Change, this.teamBookChange, this);\r\n        EventMgr.onMsg(proto.Ptl.SetFincaBattleBookIdsRsp, this.on_s2c_SetFincaBattleBookIdsRsp, this);\r\n    }\r\n    teamBookChange(index: number) {\r\n        this.teamToggleArray[index - 1].setData(index - 1);\r\n        this.checkEmpty();\r\n        this.showBookView(true);\r\n        this.updateWeaponInfoItem();\r\n    }\r\n    checkEmpty() {\r\n        const _emptyIndex = FincaFightData.ins.getBookEmptyIndex()\r\n        if (_emptyIndex) {\r\n            this.onClickTeamToggle(null, String(_emptyIndex));\r\n            const _toggle = this.teamToggleArray[_emptyIndex - 1].node.getComponent(Toggle);\r\n            _toggle.isChecked = true;\r\n            FincaFightData.ins.curSelectBook = FincaFightData.ins.bookIds[_emptyIndex - 1];\r\n        }\r\n    }\r\n    initData() {\r\n        for (let i = 0; i < this.teamToggleArray.length; i++) {\r\n            const v = this.teamToggleArray[i];\r\n            if (i === 0) {\r\n                FincaFightData.ins.BookToggleIndex = 1;\r\n            }\r\n            v.setData(i)\r\n        }\r\n\r\n        this._vocationType = tab.HeroClass.HeroClass_Any;\r\n        const _toggle = this.vocationToggleNode.getChildByName(\"Toggle\" + this._vocationType).getComponent(Toggle);\r\n        _toggle.isChecked = true;\r\n        this.checkEmpty();\r\n        this.updateWeaponInfoItem();\r\n        this.showBookView(true)\r\n    }\r\n    groupBookList() {\r\n        const result = [];\r\n        const bookList = FincaFightData.ins.getBookList().get(this._vocationType);\r\n        for (let i = 0; i < bookList.length; i += this._lineHeroCount) {\r\n            result.push(bookList.slice(i, i + this._lineHeroCount));\r\n        }\r\n        return result;\r\n    }\r\n    showBookView(isInit: boolean) {\r\n        // 刷新背包列表\r\n        this._list = this.groupBookList();\r\n        if (isInit) {\r\n            this.list_books.Init({\r\n                getCellNumber: this.getCellCount.bind(this),\r\n                getCellSize: this.getCellHeight.bind(this),\r\n                getCellIdentifer: this.getCellIdentifer.bind(this),\r\n                getCellView: this.getCellView.bind(this),\r\n                getCellData: this.GetCellData.bind(this),\r\n            });\r\n        } else {\r\n            this.list_books.Refresh();\r\n        }\r\n        this.list_books.scrollToOffset(new Vec2(0, 0), 1, true)\r\n    }\r\n    getCellCount() {\r\n        return this._list.length;\r\n    }\r\n    getCellHeight() {\r\n        return 150;\r\n    }\r\n    getCellIdentifer() {\r\n        return \"FincaFightStageWeaponLayoutItem\";\r\n    }\r\n    getCellView() {\r\n        return instantiate(this.pfb_book_item).getComponent(FincaFightStageWeaponLayoutItem);\r\n    }\r\n    GetCellData(idx: number) {\r\n        return this._list[idx]\r\n    }\r\n    switchVocation(event: EventTouch, vocationType: string) {\r\n        if (this._vocationType == Number(vocationType)) {\r\n            return;\r\n        }\r\n        this._vocationType = Number(vocationType);\r\n        this.showBookView(true);\r\n    }\r\n    onClickTeamToggle(event: EventTouch, curIndex: string) {\r\n        if (FincaFightData.ins.BookToggleIndex === Number(curIndex)) {\r\n            return\r\n        }\r\n\r\n        if (FincaFightData.ins.getBookState(Number(curIndex)) === FincaFightTeamState.LOCK) {\r\n            const _toggle = this.teamToggleArray[FincaFightData.ins.BookToggleIndex - 1].node.getComponent(Toggle);\r\n            _toggle.isChecked = true;\r\n            return;\r\n        }\r\n        FincaFightData.ins.BookToggleIndex = Number(curIndex);\r\n        FincaFightData.ins.curSelectBook = FincaFightData.ins.bookIds[FincaFightData.ins.BookToggleIndex - 1];\r\n        this.updateWeaponInfoItem();\r\n        this.showBookView(true);\r\n    }\r\n    updateWeaponInfoItem() {\r\n        if (FincaFightData.ins.curSelectBook) {\r\n            this.node_no_weapon.active = false;\r\n            this.WeaponInfoItem.node.active = true;\r\n            let bookInfo = RareBookData.ins.getBookInfoByItemId(FincaFightData.ins.curSelectBook);\r\n            this.WeaponInfoItem.initData(bookInfo);\r\n            this.WeaponInfoItem.setShowStar(bookInfo.bookTable.Aptitude == tab.HeroAptitude.HeroAptitude_SR);\r\n        } else {\r\n            this.node_no_weapon.active = true;\r\n            this.WeaponInfoItem.node.active = false;\r\n        }\r\n    }\r\n    // 请求保存阵容\r\n    @ButtonLock(1, () => { })\r\n    onClickSaveTeam() {\r\n        FincaFightData.ins.bookIds = moveZeroes(FincaFightData.ins.bookIds);\r\n        FincaFightControl.ins.reqSetFincaBattleBookIds(FincaFightData.ins.bookIds);\r\n    }\r\n    on_s2c_SetFincaBattleBookIdsRsp(msg: proto.Msg_SetFincaBattleBookIdsRsp) {\r\n        if (msg.error && msg.error.code != proto.CommonErrorCode.Succeed) return;\r\n        for (let i = 0; i < this.teamToggleArray.length; i++) {\r\n            const v = this.teamToggleArray[i];\r\n            if (i === 0) {\r\n                FincaFightData.ins.BookToggleIndex = 1;\r\n            }\r\n            v.setData(i)\r\n        }\r\n        this.checkEmpty();\r\n    }\r\n}\r\n\r\n\r\n"]}