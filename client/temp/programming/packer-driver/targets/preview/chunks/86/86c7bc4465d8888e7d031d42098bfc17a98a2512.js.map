{"version":3,"sources":["file:///C:/chickenStarClient/client/assets/scripts/logic/model/hero/herobag/HeroBookView.ts"],"names":["_decorator","Component","instantiate","Label","Prefab","UITransform","InfiniteList","tab","HeroDataControl","HeroBagLayoutCell","HeroBookLayoutQuality","EventMgr","LocalEvent","ccclass","property","HeroBookView","_lineHeroCount","_list","_type","HeroClass","HeroClass_Max","_bookIndex","onLoad","showAllHeros","type","isInit","groupHeroList","getBookIndex","lbl_cur_count","string","String","ins","getBookActiveHeroCount","lbl_totle_count","getData","HeroTable","length","list_all_heros","Init","getCellNumber","getCellCount","bind","getCellSize","getCellHeight","getCellIdentifer","getCellView","getCellData","GetCellData","Reload","pos","GetScrollPosOfCell","maxY","getContent","getComponent","height","max_y","y","setContentPos","Refresh","i","list","k","bookId","idx","data","identifer","cell","pfb_hero_item","pfb_hero_quality","result","bookList","getBookHeroListByVocation","bookHeroList","quality","HeroAptitude","HeroAptitude_SSR","itemId","heroTab","HeroTableById","getValue","Aptitude","push","_itemId","_heroTab","_quality","j","slice","refreshBookByItemId","index","layout","findCellOfIdx","ts","updateBookCell","refreshBookData","emitLocal","Hero_Change"],"mappings":"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","sourcesContent":["import { _decorator, Component, instantiate, Label, Node, Prefab, UITransform, Vec2 } from 'cc';\r\nimport InfiniteList from '../../../../Common/InfiniteList/InfiniteList';\r\nimport { tab } from '../../../../Table/table_gen';\r\nimport { HeroDataControl } from './HeroDataControl';\r\nimport { HeroBagLayoutCell } from './HeroBagLayoutCell';\r\nimport { HeroBookLayoutQuality } from './HeroBookLayoutQuality';\r\nimport { EventMgr } from '../../../mgr/EventMgr';\r\nimport { LocalEvent } from '../../../define/LocalEvent';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('HeroBookView')\r\nexport class HeroBookView extends Component {\r\n    @property(InfiniteList)\r\n    list_all_heros: InfiniteList = null;\r\n    @property(Prefab)\r\n    pfb_hero_item: Prefab = null;\r\n    @property(Prefab)\r\n    pfb_hero_quality: Prefab = null;\r\n    @property(Label)\r\n    lbl_cur_count:Label = null;\r\n    @property(Label)\r\n    lbl_totle_count:Label = null;\r\n    private _lineHeroCount = 3;\r\n    private _list = []\r\n    private _type:tab.HeroClass = tab.HeroClass.HeroClass_Max\r\n    private _bookIndex = 0;\r\n    onLoad(): void {\r\n        \r\n    }\r\n    showAllHeros(type:tab.HeroClass,isInit:boolean){\r\n        this._bookIndex = 0;\r\n        this._type = type;\r\n        this._list = this.groupHeroList(type);\r\n        this.getBookIndex();\r\n        this.lbl_cur_count.string = String(HeroDataControl.ins.getBookActiveHeroCount());\r\n        this.lbl_totle_count.string = String(tab.getData().HeroTable.length);\r\n        if(isInit){\r\n            this.list_all_heros.Init({\r\n                getCellNumber: this.getCellCount.bind(this),\r\n                getCellSize: this.getCellHeight.bind(this),\r\n                getCellIdentifer: this.getCellIdentifer.bind(this),\r\n                getCellView: this.getCellView.bind(this),\r\n                getCellData: this.GetCellData.bind(this),\r\n            });\r\n            this.list_all_heros.Reload(true);\r\n            if(this._bookIndex>=1){\r\n                const pos = this.list_all_heros.GetScrollPosOfCell(this._bookIndex);\r\n                const maxY = this.list_all_heros.getContent().getComponent(UITransform).height-435;\r\n                let max_y = pos.y>maxY?maxY:pos.y;\r\n                this.list_all_heros.setContentPos(max_y,0, max_y);\r\n            }\r\n        }else{\r\n            this.list_all_heros.Refresh();\r\n        }\r\n    }\r\n    getBookIndex(){\r\n        for(let i=0;i<this._list.length;i++){\r\n            let list = this._list[i];\r\n            if(list.length>0){\r\n                for(let k=0;k<list.length;k++){\r\n                    if(list[k]===HeroDataControl.ins.bookId){\r\n                        this._bookIndex = i;\r\n                        return;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    getCellCount() {\r\n        return this._list.length\r\n    }\r\n    getCellHeight(idx: number) {\r\n        let data = this._list[idx];\r\n        if(data.length){\r\n            return 185;\r\n        }else{\r\n            return 40;\r\n        }\r\n    }\r\n    getCellIdentifer(idx:number) {\r\n        let data = this._list[idx];\r\n        if(data.length){\r\n            return \"HeroBagLayoutCell\";\r\n        }else{\r\n            return \"HeroBookLayoutQuality\"\r\n        }\r\n    }\r\n    getCellView(idx: number, identifer: string) {\r\n        let cell = null;\r\n        switch (identifer) {\r\n            case \"HeroBagLayoutCell\":\r\n                cell = instantiate(this.pfb_hero_item).getComponent(HeroBagLayoutCell);\r\n                break;\r\n            case \"HeroBookLayoutQuality\":\r\n                cell = instantiate(this.pfb_hero_quality).getComponent(HeroBookLayoutQuality);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n        return cell;\r\n    }\r\n    GetCellData(idx: number) {\r\n        return  this._list[idx];\r\n    }\r\n\r\n    /* 将英雄数据分组 */\r\n    groupHeroList(type:tab.HeroClass) {\r\n        const result = [];\r\n        let bookList = HeroDataControl.ins.getBookHeroListByVocation(type,false);\r\n        /* 将heroList 按照品质分类 */\r\n        let bookHeroList = [[]];\r\n        let quality:tab.HeroAptitude = tab.HeroAptitude.HeroAptitude_SSR;\r\n        let idx = 0;\r\n        for(let i = 0; i < bookList.length;i++){\r\n            let itemId = bookList[i];\r\n            let heroTab = tab.getData().HeroTableById.getValue(itemId);\r\n            if(heroTab.Aptitude!==quality){\r\n                quality = heroTab.Aptitude;\r\n                idx+=1;\r\n                bookHeroList[idx] = [];\r\n            }\r\n            bookHeroList[idx].push(bookList[i]);\r\n        }\r\n        for(let k=0;k<bookHeroList.length;k++){\r\n            let _itemId = bookHeroList[k][0];\r\n            let _heroTab = tab.getData().HeroTableById.getValue(_itemId);\r\n            let _quality:tab.HeroAptitude = _heroTab.Aptitude;\r\n            result.push(_quality)\r\n            for (let j = 0; j < bookHeroList[k].length; j += this._lineHeroCount) {\r\n                result.push(bookHeroList[k].slice(j, j + this._lineHeroCount));\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n    /* 刷新列表中的元素 */\r\n    refreshBookByItemId(itemId:number){\r\n        let bookList = this.groupHeroList(this._type);\r\n        let index = 0;\r\n        for(let i = 0;i<bookList.length;i++){\r\n            let data = bookList[i];\r\n            if(data.length===0){\r\n                continue;\r\n            }  \r\n            for(let j=0;j<data.length;j++){\r\n                let _itemId = data[j];\r\n                if(_itemId===itemId){\r\n                    index = i\r\n                }\r\n            }\r\n        }\r\n        let layout = this.list_all_heros.findCellOfIdx(index);\r\n        let ts:HeroBagLayoutCell = layout.getComponent(HeroBagLayoutCell);\r\n        ts.updateBookCell(itemId);\r\n        this.lbl_cur_count.string = String(HeroDataControl.ins.getBookActiveHeroCount());\r\n        HeroDataControl.ins.refreshBookData(itemId);\r\n        EventMgr.emitLocal(LocalEvent.Hero_Change,false);\r\n    }\r\n}\r\n\r\n\r\n"]}